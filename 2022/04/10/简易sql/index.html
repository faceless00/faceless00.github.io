<!DOCTYPE html>
<html lang=" ">
<head>
  <meta charset="utf-8" />
<link rel="icon" href="/images/rev_sheep.png " />
<title>almostSalted</title>
<meta name="referrer" content="no-referrer" />
<meta name="google-site-verification" content="_CsSd0yrTQQrdEyoybq1kZNTZbIVulPo3zdQnaqAR0Y" />
  
<link rel="stylesheet" href="/css/layout.css">

<meta name="generator" content="Hexo 6.1.0"></head>
<body>
  
<link rel="stylesheet" href="/css/header.css">


<div class="topBar">
  <img class="icon" src="/images/rev_sheep.png " />
  <div class="menu">
     
    <a href="/ ">home</a>
     
    <a href="/archives ">archives</a>
     
    <a href="/categories ">categories</a>
     
    <a href="/aboutme ">aboutme</a>
     
    <a href="/diary ">diary</a>
    
  </div>
</div>
<div class="blank"></div>
  <div class="wrapper">
    
<link rel="stylesheet" href="/css/post.css">


<script src="/js/post.js"></script>


<div id="post">
  <aside id="navigator">
    <ol class="anchor"><li class="anchor-item anchor-level-1"><a class="anchor-link" href="#Prerequisites"><span class="anchor-number">1.</span> <span class="anchor-text">Prerequisites</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#AVL-%E6%A0%91"><span class="anchor-number">1.1.</span> <span class="anchor-text">AVL æ ‘</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Definition"><span class="anchor-number">1.1.1.</span> <span class="anchor-text">Definition</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#%E5%B9%B3%E8%A1%A1"><span class="anchor-number">1.1.2.</span> <span class="anchor-text">å¹³è¡¡</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="anchor-number">1.1.3.</span> <span class="anchor-text">ä»£ç å®ç°</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Conclusion"><span class="anchor-number">1.1.4.</span> <span class="anchor-text">Conclusion</span></a></li></ol></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#B-tree"><span class="anchor-number">1.2.</span> <span class="anchor-text">B tree</span></a></li></ol></li><li class="anchor-item anchor-level-1"><a class="anchor-link" href="#Content"><span class="anchor-number">2.</span> <span class="anchor-text">Content</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-1-Introduction-and-Setting-up-the-REPL"><span class="anchor-number">2.1.</span> <span class="anchor-text">Part 1-Introduction and Setting up the REPL</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Sqlite"><span class="anchor-number">2.1.1.</span> <span class="anchor-text">Sqlite</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Making-a-Simple-REPL"><span class="anchor-number">2.1.2.</span> <span class="anchor-text">Making a Simple REPL</span></a></li></ol></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-2-World%E2%80%99s-Simplest-SQL-Compiler-and-Virtual-Machine"><span class="anchor-number">2.2.</span> <span class="anchor-text">Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine</span></a></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part3-An-In-Memory-Append-Only-Single-Table-Database"><span class="anchor-number">2.3.</span> <span class="anchor-text">Part3 - An In-Memory,Append-Only,Single-Table Database</span></a></li></ol></li></ol>
  </aside>
  <div id="content">
    <div id="postHead">
      <h1>yourSql</h1>
      <div class="postDate">
        <img class="dateIcon" src="/images/clockicon.svg" />
        --2022.4.10
      </div>
        
        <div class="postCategory">
            <a href="/categories/original/">original</a>
        </div>
         
    </div>
    <div id="postBody">
      <h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><h2 id="AVL-æ ‘"><a href="#AVL-æ ‘" class="headerlink" title="AVL æ ‘"></a>AVL æ ‘</h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h3><p><code>Adelson-Velsky &amp; Landis</code>æ ‘ï¼Œä¹Ÿå«å¹³è¡¡äºŒå‰æ ‘ï¼Œç®€ç•¥çš„è¯´å°±æ˜¯<code>BST</code>å’Œé«˜åº¦å¹³è¡¡çš„äºŒå‰æ ‘çš„èåˆ</p>
<blockquote>
<p><code>BST</code>ï¼ŒäºŒå‰æœç´¢æ ‘ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä»¥æ ‘ç»“æ„å­˜å‚¨çš„å‡åºæ•°ç»„</p>
<p>é«˜åº¦å¹³è¡¡çš„äºŒå‰æ ‘ï¼Œä»»æ„èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®<code>&lt;=1</code>ï¼Œæ¯”å¦‚è¿™æ£µå°±æ˜¯<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/01a11ac9dc0c3bc1f67c7403cb1523d3.png" alt="image-20220410171609821"></p>
</blockquote>
<p><code>AVL</code>çš„é€’å½’å®šä¹‰ä¸º:</p>
<ol>
<li>æ˜¯<code>BST</code>ï¼Œä¸”å·¦å³å­æ ‘é«˜åº¦å·®çš„ç»å¯¹å€¼<code>&lt;=1</code></li>
<li>å­æ ‘ä¹Ÿæ˜¯<code>AVL</code></li>
</ol>
<blockquote>
<p><code>balance factor</code>:å¹³è¡¡å› å­ï¼Œå› ä¸º<code>AVL</code>æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæŒ‡æ ‡åˆ¤æ–­æ˜¯å¦å¹³è¡¡ï¼Œåœ¨å¤±è¡¡åè§¦å‘å¹³è¡¡æ“ä½œ</p>
<p><code>BL=abs(h(n-&gt;left)-h(n-&gt;right))</code>ï¼Œå³å·¦å³å­æ ‘çš„é«˜åº¦å·®</p>
<p>åŸºäºå¹³è¡¡å› å­ï¼Œ<code>AVL</code>çš„ç¬¬äºŒæ¡å®šä¹‰å¯ä»¥ä¸º:ä»»æ„èŠ‚ç‚¹çš„å¹³è¡¡å› å­çš„ç»å¯¹å€¼<code>&lt;=1</code></p>
<p>æ ‘çš„é«˜åº¦å®šä¹‰:</p>
<blockquote>
<p>ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è·¯å¾„åŒ…å«çš„èŠ‚ç‚¹æ•°çš„æœ€å¤§å€¼(åŒ…æ‹¬æ ¹èŠ‚ç‚¹)</p>
<p><a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/maximum-depth-of-binary-tree/">leetcode</a>ï¼Œè™½ç„¶æ±‚å¾—æ˜¯æœ€å¤§æ·±åº¦ï¼Œä¸è¿‡æ·±åº¦å’Œé«˜åº¦å…¶å®å·®ä¸å¤š</p>
<p>ååºéå†:<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/2ce9c3e7010ec20c30d927cd2d5e5975.png" alt="image-20220410173756581"></p>
<p>å…ˆåºéå†:<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/c853a40ef29f606d41b721cd861de3f6.png" alt="image-20220410174114294"></p>
</blockquote>
</blockquote>
<p>æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹ä¹‹åï¼Œè¦æ›´æ–°é«˜åº¦ï¼Œè¦æ›´æ–°é«˜åº¦çš„èŠ‚ç‚¹ä¸ºæ“ä½œèŠ‚ç‚¹çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹</p>
<h3 id="å¹³è¡¡"><a href="#å¹³è¡¡" class="headerlink" title="å¹³è¡¡"></a>å¹³è¡¡</h3><p>å¹³è¡¡æ˜¯è‡ªåº•è€Œä¸Šçš„ï¼Œå³ä»ç¦»æ“ä½œèŠ‚ç‚¹æœ€è¿‘çš„å¤±è¡¡çš„ç¥–å…ˆèŠ‚ç‚¹å¼€å§‹ï¼Œå¹³è¡¡æœ‰ä¸¤ç§æ“ä½œï¼Œå·¦æ—‹å’Œå³æ—‹</p>
<p>å³æ—‹:</p>
<blockquote>
<p><code>c.balanceFactor &gt; 1</code></p>
<p><img src="https://pic3.zhimg.com/80/v2-eee97a3e3e45d8cb6668841f6b44191a_720w.jpg" alt="img"></p>
<p><code>C</code>èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹éƒ½æ˜¯<code>&gt;=</code>B çš„ï¼Œæ‰€ä»¥å¯ä»¥æ¥åˆ° B çš„å³å­æ ‘ï¼Œå¦‚æœèŠ‚ç‚¹ B æœ‰å³å­æ ‘ï¼Œé€šå¸¸çš„ç­–ç•¥æ˜¯å…ˆæ–­å¼€ B çš„å³å­æ ‘ï¼Œå°† C æ¥åˆ° B çš„å³è¾¹ï¼Œç„¶åæŠŠå³å­æ ‘æ¥åˆ° C çš„å·¦è¾¹</p>
</blockquote>
<p>åŒç†ï¼Œå·¦æ—‹å’Œå³æ—‹åŸºæœ¬æ˜¯å¯¹ç§°çš„æ“ä½œ</p>
<p>æ—‹è½¬æ“ä½œä¼šæ”¹å˜æ ‘çš„ç»“æ„ï¼Œæ–¹ä¾¿èµ·è§ï¼ŒèŠ‚ç‚¹çš„ç»“æ„ä¸­<code>parent</code>ä¸ºæŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆ</p>
<p>å·¦æ—‹ç¤ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    Node* left;</span><br><span class="line">    Node* right;</span><br><span class="line">    Node* parent;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    <span class="type">int</span> factor;</span><br><span class="line">&#125;node,*nptr;</span><br><span class="line"><span class="function">node* <span class="title">LeftRotate</span><span class="params">(node* cur)</span> </span>&#123;	<span class="comment">//å·¦æ—‹cur</span></span><br><span class="line">    <span class="keyword">if</span> (!cur) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (cur-&gt;parent) &#123;</span><br><span class="line">        node* n =</span><br><span class="line">            (cur-&gt;parent-&gt;left == cur) ? cur-&gt;parent-&gt;left : cur-&gt;parent-&gt;right;</span><br><span class="line">        n = cur-&gt;right;</span><br><span class="line">        cur-&gt;right-&gt;parent = cur-&gt;parent;</span><br><span class="line">    &#125;</span><br><span class="line">    node* cr = cur-&gt;right;</span><br><span class="line">    node* crl = cr-&gt;left;</span><br><span class="line">    <span class="keyword">if</span> (crl) crl-&gt;parent = cur;</span><br><span class="line">    cur-&gt;right = crl;</span><br><span class="line">    cr-&gt;left = cur;</span><br><span class="line">    <span class="keyword">return</span> cur-&gt;parent = cr;	<span class="comment">//cur-&gt;parent=cr;return cr;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/9a705d5ca9bc82655603ccbe19cbc402.png" alt="image-20220411224513434"></p>
<p><code>x</code>æ˜¯æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶ R çš„å¹³è¡¡å› å­ä¸º<code>&gt; 1</code>ï¼Œè¿™ç§æƒ…å†µå¯ä»¥å«åš<code>LL</code>å‹ï¼ŒR çš„<strong>å·¦å­æ ‘</strong>RL çš„<strong>å·¦å­æ ‘</strong>æ–°æ’å…¥äº†èŠ‚ç‚¹ï¼Œå¹³è¡¡æ“ä½œä¸ºèŠ‚ç‚¹ R å³æ—‹</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/13bd3c2daacc4cacd35af2f113b079c5.png" alt="image-20220411224902843">ç„¶åå°±å¹³è¡¡äº† ğŸ¤ </p>
<p>å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/9a57fd7e0fff43b08f3b2b3061e5b160.png" alt="image-20220411225349437"></p>
<p>R çš„å¹³è¡¡å› å­ä»ç„¶æ˜¯ 2,ä½†æ˜¯æ’å…¥çš„èŠ‚ç‚¹åœ¨ RL çš„å³å­æ ‘ï¼Œè¿™ç§æƒ…å†µå¯ä»¥å«åš LR å‹ï¼Œéœ€è¦è¿›è¡Œä¸¤æ¬¡æ—‹è½¬æ“ä½œç„¶åå¹³è¡¡</p>
<p>é¦–å…ˆç»™ RL å·¦æ—‹:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/65c9aca259f50d0751f6b59d9492db2f.png" alt="image-20220411225739881">èªæ˜çš„ä½ ä¸€å®šå‘ç°äº†ï¼Œå·¦æ—‹ä¹‹åå˜æˆäº† LL å‹ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å†ç»™ R è¿›è¡Œä¸€æ¬¡å³æ—‹æ“ä½œ:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/be1b88cbb344601ef3faee1320fafe5a.png" alt="image-20220411225944026">äºæ˜¯åˆå¹³è¡¡äº†</p>
<p>å½“ç„¶ï¼ŒLR å‹åŒ…å«äº†ä¸‰ç§æƒ…å†µï¼Œè¿™é‡Œæ˜¯<code>RRR</code>èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º<code>-1</code>ï¼Œè¿˜æœ‰<code>0 1</code>è¿™ä¸¤ç§ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡å·¦æ—‹<code>RL</code>èŠ‚ç‚¹ï¼Œå˜æˆ<code>LL</code>å‹ï¼Œç„¶åå³æ—‹<code>R</code>æœ€ç»ˆå¹³è¡¡</p>
<p>è‡³äº<code>RR,RL</code>å‹ï¼Œå’Œ<code>LL,LR</code>æ˜¯<strong>å¯¹ç§°</strong>æ“ä½œï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æ‡’å¾—å†™â€¦ä»¥åè¡¥</p>
<p><code>AVL</code>ä¸æ™®é€š<code>BST</code>æœ‰åŒºåˆ«çš„æ“ä½œåœ¨äº<strong>æ’å…¥å’Œåˆ é™¤</strong>æ—¶ï¼Œéœ€è¦å¯¹å¯èƒ½å—å½±å“çš„èŠ‚ç‚¹å¹³è¡¡ï¼Œå¯èƒ½å—å½±å“çš„èŠ‚ç‚¹ï¼Œå®é™…ä¸Šå°±æ˜¯æ“ä½œèŠ‚ç‚¹çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œå› ä¸ºè¿™äº›èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¼šå‘ç”Ÿå˜åŒ–(å­æ ‘é«˜åº¦å˜äº†)</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>å®é™…ä¸Šï¼Œ<code>AVL</code>å°±æ˜¯ä¸€æ£µç‰¹æ®Šçš„<code>BST</code>ï¼Œåªæ˜¯å¯¹é«˜åº¦è¿›è¡Œäº†é™åˆ¶ï¼Œé‚£ä¹ˆï¼Œ<code>AVL</code>çš„åº”ç”¨åœºæ™¯åœ¨ä»€ä¹ˆåœ°æ–¹æï¼Ÿ</p>
<p>ä¼ ç»Ÿçš„<code>BST</code>å¾ˆå®¹æ˜“é€€åŒ–æˆä¸€æ¡é“¾ï¼Œè¿™æ—¶çš„æŸ¥æ‰¾å¤æ‚åº¦å°±å˜æˆäº†<code>O(n)</code>ï¼Œè€Œ<code>AVL</code>é€šè¿‡å¹³è¡¡ï¼Œä¿è¯æ ‘æ•´ä½“ç»“æ„ç›¸å¯¹å¯¹ç§°ï¼ŒæŸ¥æ‰¾å¤æ‚åº¦æ€»æ˜¯<code>O(logn)</code></p>
<p>ä¸è¿‡ç”±äºå¹³è¡¡æ“ä½œå¾ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥åªé€‚åˆå°‘é‡å¢åˆ èŠ‚ç‚¹ï¼Œå¤§é‡æŸ¥è¯¢çš„åœºæ™¯</p>
<h2 id="B-tree"><a href="#B-tree" class="headerlink" title="B tree"></a>B tree</h2><p>B ä½ å¦ˆ</p>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><h2 id="Part-1-Introduction-and-Setting-up-the-REPL"><a href="#Part-1-Introduction-and-Setting-up-the-REPL" class="headerlink" title="Part 1-Introduction and Setting up the REPL"></a>Part 1-Introduction and Setting up the REPL</h2><p>ä½œä¸ºä¸€ä¸ªç½‘ç»œå¼€å‘è€…ï¼Œæˆ‘æ¯å¤©éƒ½åœ¨å·¥ä½œä¸­ä½¿ç”¨å…³è”æ€§æ•°æ®åº“ï¼Œä½†æ˜¯å®ƒä»¬å¯¹äºæˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªé»‘ç›’å­.æˆ‘æœ‰ä¸€äº›ç–‘æƒ‘:</p>
<ul>
<li>æ•°æ®å­˜å‚¨å½¢å¼æ˜¯ä»€ä¹ˆï¼Ÿ(å†…å­˜å’Œç£ç›˜)</li>
<li>æ•°æ®ä»€ä¹ˆæ—¶å€™ä»å†…å­˜ä¸­ç§»åŠ¨åˆ°ç£ç›˜ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆæ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸» keyï¼Ÿ</li>
<li>å›æ»šäº‹åŠ¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</li>
<li>ç´¢å¼•æ˜¯å¦‚ä½•æ ¼å¼åŒ–çš„ï¼Ÿ</li>
<li>å…¨è¡¨æ‰«æä½•æ—¶ä»¥åŠå¦‚ä½•å‘ç”Ÿï¼Ÿ</li>
<li>å³å°†æ‰§è¡Œçš„è¯­å¥ä»¥ä»€ä¹ˆæ ¼å¼å‚¨å­˜ï¼Ÿ</li>
</ul>
<p>æ¢å¥è¯è¯´å°±æ˜¯ï¼Œæ•°æ®åº“æ˜¯å¦‚ä½• <strong>å·¥ä½œ</strong> çš„ï¼Ÿ</p>
<p>ä¸ºäº†æŠŠäº‹æƒ…å¼„æ¸…æ¥šï¼Œæˆ‘æ­£åœ¨ä»å¤´å¼€å§‹å†™ä¸€ä¸ªæ•°æ®åº“.å®ƒä»¥ sqlite ä¸ºæ¨¡æ¿ï¼Œå› ä¸ºå®ƒè¢«è®¾è®¡ä¸ºå°ä½“ç§¯ï¼ŒåŠŸèƒ½æ¯” MySql æˆ– PostgreSQL å°‘ï¼Œæ‰€ä»¥æˆ‘æ›´æœ‰å¸Œæœ›ç†è§£å®ƒ.æ•´ä¸ªæ•°æ®åº“è¢«å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­!</p>
<h3 id="Sqlite"><a href="#Sqlite" class="headerlink" title="Sqlite"></a>Sqlite</h3><p>åœ¨ Sqlite ç½‘ç«™ä¸Šæœ‰è®¸å¤š <a target="_blank" rel="noopener" href="https://www.sqlite.org/arch.html">å…³äº sqilite çš„å†…éƒ¨ç»“æ„çš„æ–‡ç« </a>ï¼Œæ­¤å¤–æˆ‘æœ‰ä¸€ä»½èµ„æ–™<a target="_blank" rel="noopener" href="https://play.google.com/store/books/details?id=9Z6IQQnX1JEC">SQLite Database System:Design and Implementation</a>.</p>
<p>sqlite ç»“æ„(<a target="_blank" rel="noopener" href="https://www.sqlite.org/zipvfs/doc/trunk/www/howitworks.wiki">howitworks.wiki</a>)</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch1.gif" alt="img"></p>
<p>ä¸€æ¬¡æŸ¥è¯¢é€šè¿‡ä¸€ç³»åˆ—ç»„ä»¶æ¥æ£€ç´¢æˆ–ä¿®æ”¹æ•°æ®.<strong>å‰ç«¯</strong> åŒ…æ‹¬:</p>
<ul>
<li>tokenizer</li>
<li>parser</li>
<li>code generator</li>
</ul>
<p>å‰ç«¯çš„è¾“å…¥æ˜¯ä¸€ä¸ª SQL æŸ¥è¯¢ï¼Œè¾“å‡ºæ˜¯ sqlite è™šæ‹Ÿå­—èŠ‚ç (æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯è¢«æ•°æ®åº“æ‰§è¡Œçš„ç¼–è¯‘ç¨‹åº).</p>
<p><strong>åç«¯</strong> åŒ…æ‹¬:</p>
<ul>
<li>virtual machine</li>
<li>B-tree</li>
<li>pager</li>
<li>os interface</li>
</ul>
<p><strong>è™šæ‹Ÿæœº</strong> å°†å‰ç«¯ç”Ÿæˆçš„å­—èŠ‚ç å½“ä½œæŒ‡ä»¤.å®ƒå¯ä»¥åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨æ ¼æˆ–ç´¢å¼•ä¸Šæ‰§è¡Œæ“ä½œï¼Œæ¯ä¸ªè¡¨æˆ–ç´¢å¼•éƒ½è¢«å­˜å‚¨åœ¨ä¸€ä¸ªå«åš<code>B-tree</code>çš„æ•°æ®ç»“æ„ä¸­.è™šæ‹Ÿæœºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª switch è¯­å¥ï¼Œæ¡ä»¶æ˜¯å­—èŠ‚ç æŒ‡ä»¤.</p>
<p>æ¯ä¸ª<code>B-tree</code>åŒ…æ‹¬è®¸å¤šèŠ‚ç‚¹.æ¯ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ä¸ºä¸€é¡µ.<code>B-tree</code>å¯ä»¥ä»ç£ç›˜ä¸­è¯»å–ä¸€é¡µæˆ–è€…é€šè¿‡å‘<code>pager</code>å‘å‡ºæŒ‡ä»¤ç„¶åå°†ä¸€é¡µå­˜å‚¨åˆ°ç£ç›˜ä¸Š.</p>
<p><strong>pager</strong> æ¥æ”¶å‘½ä»¤ä»¥è¯»å–æˆ–å†™å…¥æ•°æ®é¡µ.å®ƒè´Ÿè´£åœ¨åˆé€‚çš„ä½ç½®è¯»å–&#x2F;å†™å…¥æ•°æ®ï¼Œè¿˜å°†æœ€è¿‘è·å–çš„å‡ é¡µçš„ç¼“å­˜ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”å†³å®šé‚£äº›é¡µä½•æ—¶è¢«å†™å›ç£ç›˜.</p>
<p><strong>os interface(ç³»ç»Ÿæ¥å£)</strong> å±‚æ ¹æ® sqlite è¢«ç¼–è¯‘çš„å¹³å°è€Œæœ‰æ‰€åŒºåˆ«.åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä¸æ‰“ç®—æ”¯æŒå¤šä¸ªæ“ä½œç³»ç»Ÿ.</p>
<p><a target="_blank" rel="noopener" href="https://en.wiktionary.org/wiki/a_journey_of_a_thousand_miles_begins_with_a_single_step">åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹</a>ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»¥æ›´ç›´æ¥çš„æ–¹å¼å¼€å§‹:<code>the REPL(read-eval-print loop)</code></p>
<h3 id="Making-a-Simple-REPL"><a href="#Making-a-Simple-REPL" class="headerlink" title="Making a Simple REPL"></a>Making a Simple REPL</h3><p>å½“ä»å‘½ä»¤è¡Œæ‰§è¡Œ sqlite æ—¶ï¼Œä¼šè¿›å…¥ä¸€ä¸ªè¯»å–-æ‰§è¡Œ-è¾“å‡ºå¾ªç¯:</p>
<blockquote>
<p>~ sqlite3<br>SQLite version 3.16.0 2016-11-04 19:09:39<br>Enter â€œ.helpâ€ for usage hints.<br>Connected to a transient in-memory database.<br>Use â€œ.open FILENAMEâ€ to reopen on a persistent database.<br>sqlite&gt; create table users (id int, username varchar(255), email varchar(255));<br>sqlite&gt; .tables<br>users<br>sqlite&gt; .exit<br>~</p>
</blockquote>
<p>ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬çš„ main å‡½æ•°å°†ä¼šæœ‰ä¸€ä¸ªæ— æ­¢å¢ƒçš„å¾ªç¯ï¼Œæ‰“å°æç¤ºï¼Œè·å–ä¸€è¡Œè¾“å…¥ï¼Œç„¶åæ‰§è¡Œè¿™è¡Œè¾“å…¥:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">print_prompt</span>();</span><br><span class="line">    <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cout&lt;&lt;<span class="string">&quot;Unrecognized command &quot;</span>&lt;&lt;</span><br><span class="line">          &lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°†<code>InputBuffer</code>å®šä¹‰ä¸ºä¸€ä¸ªå°åŒ…è£…å™¨ä»¥ä¾¿å­˜å‚¨å’Œ<code>getline</code>(<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man3/getline.3.html">ref</a>)äº¤äº’æ—¶çš„çŠ¶æ€.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="type">char</span>* buffer;</span><br><span class="line">	<span class="type">size_t</span> buffer_length;</span><br><span class="line">	<span class="type">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span>&#123;</span><br><span class="line">	InputBuffer* input_buffer=InputBuffer* <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">	input_buffer-&gt;buffer=<span class="literal">NULL</span>;</span><br><span class="line">	input_buffer-&gt;buffer_length=<span class="number">0</span>;</span><br><span class="line">	input_buffer-&gt;input_length=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶å,<code>print_prompt()</code>ç»™ç”¨æˆ·æ‰“å°æç¤ºï¼Œåœ¨è¯»å–ä¸€è¡Œè¾“å…¥ä¹‹å‰.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_prompt</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;db &gt; &quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è¯»å–ä¸€è¡Œè¾“å…¥ï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man3/getline.3.html">getline</a>:</p>
<p><code>ssize_t getline(char **lineptr,size_t *n,FILE *stream);</code></p>
<p><code>lineptr</code>:ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ç”¨æ¥æŒ‡å‘åŒ…å«è¯»å–çš„è¡Œçš„ç¼“å†²åŒºçš„å˜é‡.å¦‚æœåœ¨è°ƒç”¨<code>getline()</code>ä¹‹å‰<code>*lineptr</code>è¢«è®¾ä¸º<code>NULL</code>ï¼Œé‚£ä¹ˆ<code>getline()</code>å°†ä¼šåˆ†é…ä¸€ä¸ªç¼“å†²åŒºç”¨æ¥å­˜å‚¨è¡Œï¼Œè¿™ä¸ªç¼“å†²åŒºåº”è¯¥ç”±ç”¨æˆ·é‡Šæ”¾ï¼Œå³ä½¿<code>getline()</code>è°ƒç”¨å¤±è´¥.</p>
<p><code>n</code>:ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ç”¨æ¥å­˜å‚¨åˆ†é…çš„ç¼“å†²åŒºçš„å¤§å°çš„å˜é‡.</p>
<p><code>stream</code>:ç”¨æ¥è¯»å–çš„è¾“å…¥æµ.æˆ‘ä»¬å°†ä»æ ‡å‡†è¾“å…¥æµä¸­è¯»å–.</p>
<p><code>return value</code>:è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯èƒ½å°äºç¼“å†²åŒºçš„å¤§å°.</p>
<p>æˆ‘ä»¬è®©<code>getline</code>è¯»å–çš„è¡Œå­˜å‚¨åœ¨<code>input_buffer-&gt;buffer</code>ï¼Œç¼“å†²åŒºå¤§å°æ˜¯<code>input_buffer-&gt;buffer_length</code>ï¼Œè¿”å›å€¼å­˜å‚¨åœ¨<code>input_buffer-&gt;input_length</code></p>
<p><code>buffer</code>çš„åˆå§‹å€¼ä¸ºnullï¼Œæ‰€ä»¥<code>getline</code>ä¼šåˆ†é…è¶³å¤Ÿçš„ç©ºé—´æ¥ä¿å­˜è¾“å…¥è¡Œï¼Œç„¶åè®©<code>buffer</code>æŒ‡å‘è¯¥ç©ºé—´.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="type">ssize_t</span> bytes_read =</span><br><span class="line">      <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), stdin);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);	<span class="comment">//define EXIT_FAILURE 1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¿½ç•¥æ¢è¡Œç¬¦</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;	<span class="comment">//cè¯­è¨€å­—ç¬¦ä¸²ç»“æŸæ ‡å¿—ä¸º&#x27;\0&#x27;,æ•°å€¼ä¸º0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ˜¯æ—¶å€™å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨æ¥é‡Šæ”¾åˆ†é…ç»™<code>InputBuffer *</code>å®ä¾‹ä»¥åŠæˆå‘˜å˜é‡<code>buffer</code>çš„ç©ºé—´äº†(è°ƒç”¨<code>read_input</code>çš„æ—¶å€™<code>getline</code>ç»™<code>input_buffer-&gt;buffer</code>åˆ†é…äº†å†…å­˜).</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);	<span class="comment">//æ˜¾ç„¶,æ˜¯ç”¨å †åˆ†é…çš„ç©ºé—´</span></span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œè§£æç„¶åæ‰§è¡Œå‘½ä»¤.ç›®å‰åªæœ‰ä¸€ä¸ªå‘½ä»¤å¯ä»¥è¢«è¯†åˆ«:<code>.exit</code>ï¼Œç”¨æ¥ç»ˆæ­¢ç¨‹åºï¼Œå¦‚æœä¸æ˜¯<code>.exit</code>å°±æ‰“å°é”™è¯¯æ¶ˆæ¯ç„¶åç»§ç»­å¾ªç¯.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°è¯•è¿è¡Œå®ƒå§~</p>
<blockquote>
<p>~ .&#x2F;db<br>db &gt; .tables<br>Unrecognized command â€˜.tablesâ€™.<br>db &gt; .exit<br>~</p>
</blockquote>
<p>å¥½äº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæœ‰ç”¨çš„REPL.åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œå°†è¦å¼€å‘æˆ‘ä»¬çš„å‘½ä»¤è¯­è¨€.</p>
<p>é¡ºä¾¿ï¼Œè¿™æ˜¯è¿™éƒ¨åˆ†çš„å…¨éƒ¨ä»£ç :</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="type">char</span>* buffer;</span><br><span class="line">  <span class="type">size_t</span> buffer_length;</span><br><span class="line">  <span class="type">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">  input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">  input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">  input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_prompt</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;db &gt; &quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="type">ssize_t</span> bytes_read =</span><br><span class="line">      <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), stdin);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore trailing newline</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">print_prompt</span>();</span><br><span class="line">    <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Part-2-Worldâ€™s-Simplest-SQL-Compiler-and-Virtual-Machine"><a href="#Part-2-Worldâ€™s-Simplest-SQL-Compiler-and-Virtual-Machine" class="headerlink" title="Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine"></a>Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine</h2><p>æˆ‘ä»¬æ­£åœ¨å…‹éš†ä¸€ä»½sqlite.sqliteçš„<strong>å‰ç«¯</strong>æ˜¯ä¸€ä¸ªSQLç¼–è¯‘å™¨ï¼Œç”¨æ¥è§£æè¾“å…¥çš„å­—ç¬¦ä¸²ç„¶åè¾“å‡ºä¸€ç§å«åš<code>bytecode</code>(å­—èŠ‚ç )çš„å†…éƒ¨è¡¨ç¤º.</p>
<p>bytecodeè¢«ä¼ å…¥è™šæ‹Ÿæœº,ç„¶åç”±è™šæ‹Ÿæœºæ‰§è¡Œ.</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch2.gif" alt="img"></p>
<p>å°†äº‹æƒ…åˆ†æˆè¿™æ ·çš„ä¸¤æ­¥æœ‰2ä¸ªå¥½å¤„:</p>
<ul>
<li>å‡å°‘æ¯ä¸€éƒ¨åˆ†çš„å¤æ‚æ€§(e.g. è™šæ‹Ÿæœºä¸å…³å¿ƒè¯­æ³•é”™è¯¯)</li>
<li>Allows compiling common queries once and caching the bytecode for improved performance.</li>
</ul>
<p>è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬é‡æ„mainå‡½æ•°å¹¶ä¸”åœ¨è¿‡ç¨‹ä¸­æ”¯æŒä¸¤ä¸ªæ–°çš„å…³é”®è¯:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer)) &#123;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          cout&lt;&lt;<span class="string">&quot;Unrecognized command: &quot;</span>&lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        cout&lt;&lt;<span class="string">&quot;Unrecognized keyword at start of: &quot;</span>&lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="built_in">execute_statement</span>(&amp;statement);</span><br><span class="line">+    cout&lt;&lt;<span class="string">&quot;Executed.&quot;</span>&lt;&lt;endl;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>éSQLè¯­å¥åƒæ˜¯<code>.exit</code>è¢«ç§°ä½œ <strong>å…ƒå‘½ä»¤</strong>.å…ƒå‘½ä»¤ä»¥<code>.</code>å¼€å§‹,å› æ­¤æˆ‘ä»¬æ£€æŸ¥å¹¶åœ¨å•ç‹¬çš„å‡½æ•°ä¸­å¤„ç†å…ƒå‘½ä»¤.</p>
<p>ç„¶åï¼ŒåŠ ä¸€æ­¥ç”¨æ¥æŠŠè¾“å…¥è¡Œè½¬æ¢ä¸ºè¯­å¥çš„å†…éƒ¨è¡¨ç¤º.This is our hacky version of the sqlite front-end.</p>
<p>æœ€åï¼ŒæŠŠå‡†å¤‡å¥½çš„è¯­å¥ä¼ é€’ç»™<code>execute_statement</code>.è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šæˆä¸ºæˆ‘ä»¬çš„è™šæ‹Ÿæœº.</p>
<p>æ³¨æ„ä¸¤ä¸ªæ–°å‡½æ•°è¿”å›çš„æ˜¯è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥çš„æšä¸¾å˜é‡:</p>
<blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">  META_COMMAND_SUCCESS,</span><br><span class="line">  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125; MetaCommandResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>â€œUnrecognized statementâ€?è¿™æœ‰ç‚¹åƒä¸€ä¸ª exception.æˆ‘ä¸å¤ªå–œæ¬¢ä½¿ç”¨exception(è€Œä¸”Cç”šè‡³éƒ½ä¸æ”¯æŒ)ï¼Œæ‰€ä»¥æˆ‘åœ¨ä»»ä½•å¯è¡Œçš„åœ°æ–¹éƒ½æ˜¯ç”¨<code>enum result code</code>.å¦‚æœswitchè¯­å¥æ²¡æœ‰å¤„ç†å…¶ä¸­ä¸€ä¸ªæšä¸¾æˆå‘˜ï¼ŒCç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ›´æœ‰ä¿¡å¿ƒåœ°å¤„ç†å‡½æ•°çš„æ¯ä¸ªç»“æœ.é¢„è®¡æœªæ¥ä¼šæ·»åŠ æ›´å¤š<code>result code</code>.</p>
<p>do_meta_commandåªæ˜¯ç°æœ‰åŠŸèƒ½çš„ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨æ¥ç»™æ›´å¤šå‘½ä»¤é¢„ç•™ç©ºé—´.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›®å‰çš„<code>prepared statement</code>åªåŒ…å«ä¸€ä¸ªæœ‰ä¸¤ä¸ªæˆå‘˜çš„æšä¸¾å˜é‡ï¼Œå› ä¸ºæˆ‘ä»¬å…è®¸statementsæœ‰å‚æ•°ï¼Œå®ƒå°†åŒ…å«æ›´å¤šæ•°æ®.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  StatementType type;</span><br><span class="line">&#125; Statement;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>prepare_statement(æˆ‘ä»¬çš„â€SQLç¼–è¯‘å™¨â€)ç°åœ¨è¿˜ä¸èƒ½ç†è§£SQLè¯­å¥.å®é™…ä¸Šå®ƒåªèƒ½ç†è§£ä¸¤ä¸ªè¯:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Statement* statement)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>strncmp</code>æ¥æ¯”è¾ƒå­—ç¬¦ä¸²å› ä¸º<code>insert</code>å•è¯åé¢è·Ÿç€æ•°æ®.(e.g. <code>insert 1 cstack foo@bar.com</code>)</p>
<p>æœ€å,<code>execute_statement</code>åŒ…å«ä¸€äº›stubs:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">    <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do an insert.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do a select.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„å‡½æ•°ä¸è¿”å›ä»»ä½•é”™è¯¯ç ,å› ä¸ºç›®å‰è¿˜ä¸ä¼šå‡ºç°é”™è¯¯.</p>
<p>é‡æ„ä¹‹åï¼Œç°åœ¨å¯ä»¥è¯†åˆ«ä¸¤ä¸ªæ–°å…³é”®å­—äº†!</p>
<blockquote>
<p>~ .&#x2F;db<br>db &gt; insert foo bar<br>This is where we would do an insert.<br>Executed.<br>db &gt; delete foo<br>Unrecognized keyword at start of â€˜delete fooâ€™.<br>db &gt; select<br>This is where we would do a select.<br>Executed.<br>db &gt; .tables<br>Unrecognized command â€˜.tablesâ€™<br>db &gt; .exit<br>~</p>
</blockquote>
<p>æˆ‘ä»¬æ•°æ®åº“ç¨‹åºçš„éª¨æ¶æ­£åœ¨é€æ­¥æ„å»ºâ€¦å¦‚æœå®ƒèƒ½å¤Ÿå­˜å‚¨æ•°æ®é‚£ä¸æ˜¯æ›´å¥½å—?åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†ä¼šå®ç°<code>insert</code>å’Œ<code>select</code>,åˆ›å»ºä¸–ç•Œä¸Šæœ€ç³Ÿç³•~çš„æ•°æ®å­˜å‚¨.é¡ºä¾¿ï¼Œè¿™é‡Œæœ‰æœ¬ç« çš„æ‰€æœ‰æ”¹åŠ¨:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@@ <span class="number">-10</span>,<span class="number">6</span> +<span class="number">10</span>,<span class="number">23</span> @@ <span class="keyword">struct</span> <span class="title class_">InputBuffer_t</span> &#123;</span><br><span class="line"> &#125; InputBuffer;</span><br><span class="line"> </span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  META_COMMAND_SUCCESS,</span><br><span class="line">+  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">+&#125; MetaCommandResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  StatementType type;</span><br><span class="line">+&#125; Statement;</span><br><span class="line">+</span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">   input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">@@ <span class="number">-40</span>,<span class="number">17</span> +<span class="number">57</span>,<span class="number">67</span> @@ <span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do an insert.\n&quot;</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do a select.\n&quot;</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"> </span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer)) &#123;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="built_in">execute_statement</span>(&amp;statement);</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Part3-An-In-Memory-Append-Only-Single-Table-Database"><a href="#Part3-An-In-Memory-Append-Only-Single-Table-Database" class="headerlink" title="Part3 - An In-Memory,Append-Only,Single-Table Database"></a>Part3 - An In-Memory,Append-Only,Single-Table Database</h2><p>æˆ‘ä»¬å…ˆå®ç°æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œå¹¶ç»™æ•°æ®åº“æ·»åŠ ä¸€äº›é™åˆ¶.ç›®å‰æ¥è¯´ï¼Œæ•°æ®åº“å°†:</p>
<ul>
<li>æ”¯æŒä¸¤ç§æ“ä½œ: æ’å…¥ä¸€è¡Œç„¶åæ‰“å°æ‰€æœ‰è¡Œ.</li>
<li>åªä¿å­˜åœ¨å†…å­˜ä¸­(è€Œä¸æ˜¯ç¡¬ç›˜)</li>
<li>æ”¯æŒå•ä¸ªï¼Œç¡¬ç¼–ç çš„è¡¨</li>
</ul>
<p>æˆ‘ä»¬çš„ç¡¬ç¼–ç è¡¨å°†ä¼šå­˜å‚¨ç”¨æˆ·ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-21/4c36e008a593cad02a5f4052452488ab.png" alt="image-20220421000123610"></p>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼Œä½†æ˜¯æ”¯æŒå¤šç§æ•°æ®ç±»å‹å’Œé•¿åº¦å¯å˜çš„å­—ç¬¦ä¸².</p>
<p><code>insert</code>è¯­å¥çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<p><code>insert 1 cstack foo@bar.com</code></p>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦æ‰©å±•<code>prepare_statement</code>å‡½æ•°ä»¥è§£æå‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">+        input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">+        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">+    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æŠŠè§£æå¾—åˆ°çš„å‚æ•°æ”¾è¿›statementå¯¹è±¡çš„æ–°æˆå‘˜Rowä¸­.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">uint32_t</span> id;</span><br><span class="line">+  <span class="type">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">+  <span class="type">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+&#125; Row;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   StatementType type;</span><br><span class="line">+  Row row_to_insert;  <span class="comment">// only used by insert statement</span></span><br><span class="line"> &#125; Statement;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦æŠŠæ•°æ®æ‹·è´åˆ°è¡¨ç¤ºè¡¨çš„æ•°æ®ç»“æ„ä¸­.SQLiteä½¿ç”¨<code>B-tree</code>ä»¥å®ç°å¿«é€ŸæŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤.æˆ‘ä»¬ä¸€å¼€å§‹å…ˆç”¨ç®€å•ç‚¹çš„æ•°æ®ç»“æ„.ç±»ä¼¼ä¸€æ£µ<code>B-tree</code>ï¼Œå®ƒå°†è¡Œå­˜è¿›é¡µä¸­ï¼Œä½†æ˜¯é¡µå¹¶ä¸ä»¥æ ‘çš„å½¢å¼ç»„ç»‡ï¼Œè€Œæ˜¯ä»¥åˆ—è¡¨çš„å½¢å¼.</p>
<p>è¿™æ˜¯æˆ‘çš„æƒ³æ³•:</p>
<ul>
<li>å°†è¡Œå­˜å‚¨åœ¨å«åšé¡µçš„å†…å­˜å—</li>
<li>æ¯ä¸€é¡µå­˜å‚¨å°½å¯èƒ½å¤šçš„è¡Œ</li>
<li>æ¯ä¸€é¡µä¸­è¡Œè¢«åºåˆ—åŒ–æˆç´§å‡‘çš„è¡¨ç°å½¢å¼</li>
<li>é¡µåªåœ¨éœ€è¦çš„æ—¶å€™åˆ†é…</li>
<li>ç»´æŠ¤ä¸€ä¸ªå®šé•¿çš„å­˜å‚¨æŒ‡å‘é¡µçš„æŒ‡é’ˆçš„æ•°ç»„</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰è¡Œçš„ç´§å‡‘çš„è¡¨ç°å½¢å¼:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="meta">#<span class="keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line">+</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_OFFSET = ID_OFFSET + ID_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_OFFSET = USERNAME_OFFSET + USERNAME_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ROW_SIZE = ID_SIZE + USERNAME_SIZE + EMAIL_SIZE;</span><br></pre></td></tr></table></figure>
    </div>
  </div>
</article> 
  </div>
  
<link rel="stylesheet" href="/css/footer.css">


<div id="footer"></div>
 
</body>