<!DOCTYPE html>
<html lang=" ">
<head>
  <meta charset="utf-8" />
<link rel="icon" href="/images/rev_sheep.png " />
<title>almostSalted</title>
<meta name="referrer" content="no-referrer" />
<meta name="google-site-verification" content="_CsSd0yrTQQrdEyoybq1kZNTZbIVulPo3zdQnaqAR0Y" />
  
<link rel="stylesheet" href="/css/layout.css">

<meta name="generator" content="Hexo 6.1.0"></head>
<body>
  
<link rel="stylesheet" href="/css/header.css">


<div class="topBar">
  <img class="icon" src="/images/rev_sheep.png " />
  <div class="menu">
     
    <a href="/ ">home</a>
     
    <a href="/archives ">archives</a>
     
    <a href="/categories ">categories</a>
     
    <a href="/aboutme ">aboutme</a>
     
    <a href="/diary ">diary</a>
    
  </div>
</div>
<div class="blank"></div>
  <div class="wrapper">
    
<link rel="stylesheet" href="/css/post.css">


<script src="/js/post.js"></script>


<div id="post">
  <aside id="navigator">
    <ol class="anchor"><li class="anchor-item anchor-level-1"><a class="anchor-link" href="#Prerequisites"><span class="anchor-number">1.</span> <span class="anchor-text">Prerequisites</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#AVL-%E6%A0%91"><span class="anchor-number">1.1.</span> <span class="anchor-text">AVL æ ‘</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Definition"><span class="anchor-number">1.1.1.</span> <span class="anchor-text">Definition</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#%E5%B9%B3%E8%A1%A1"><span class="anchor-number">1.1.2.</span> <span class="anchor-text">å¹³è¡¡</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="anchor-number">1.1.3.</span> <span class="anchor-text">ä»£ç å®ç°</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Conclusion"><span class="anchor-number">1.1.4.</span> <span class="anchor-text">Conclusion</span></a></li></ol></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#B-tree"><span class="anchor-number">1.2.</span> <span class="anchor-text">B tree</span></a></li></ol></li><li class="anchor-item anchor-level-1"><a class="anchor-link" href="#Content"><span class="anchor-number">2.</span> <span class="anchor-text">Content</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-1-Introduction-and-Setting-up-the-REPL"><span class="anchor-number">2.1.</span> <span class="anchor-text">Part 1-Introduction and Setting up the REPL</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Sqlite"><span class="anchor-number">2.1.1.</span> <span class="anchor-text">Sqlite</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Making-a-Simple-REPL"><span class="anchor-number">2.1.2.</span> <span class="anchor-text">Making a Simple REPL</span></a></li></ol></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-2-World%E2%80%99s-Simplest-SQL-Compiler-and-Virtual-Machine"><span class="anchor-number">2.2.</span> <span class="anchor-text">Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine</span></a></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part3-An-In-Memory-Append-Only-Single-Table-Database"><span class="anchor-number">2.3.</span> <span class="anchor-text">Part3 - An In-Memory,Append-Only,Single-Table Database</span></a></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-4-Our-First-Tests-and-Bugs"><span class="anchor-number">2.4.</span> <span class="anchor-text">Part 4 - Our First Tests (and Bugs)</span></a></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-5-Persistence-to-Disk"><span class="anchor-number">2.5.</span> <span class="anchor-text">Part 5 - Persistence to Disk</span></a><ol class="anchor-child"><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Conclusion-1"><span class="anchor-number">2.5.1.</span> <span class="anchor-text">Conclusion</span></a></li><li class="anchor-item anchor-level-3"><a class="anchor-link" href="#Complete-Diff"><span class="anchor-number">2.5.2.</span> <span class="anchor-text">Complete Diff</span></a></li></ol></li><li class="anchor-item anchor-level-2"><a class="anchor-link" href="#Part-6-The-Cursor-Abstraction"><span class="anchor-number">2.6.</span> <span class="anchor-text">Part 6 - The Cursor Abstraction</span></a></li></ol></li></ol>
  </aside>
  <div id="content">
    <div id="postHead">
      <h1>yourSql</h1>
      <div class="postDate">
        <img class="dateIcon" src="/images/clockicon.svg" />
        --2022.4.10
      </div>
        
        <div class="postCategory">
            <a href="/categories/original/">original</a>
        </div>
         
    </div>
    <div id="postBody">
      <h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><h2 id="AVL-æ ‘"><a href="#AVL-æ ‘" class="headerlink" title="AVL æ ‘"></a>AVL æ ‘</h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h3><p><code>Adelson-Velsky &amp; Landis</code>æ ‘ï¼Œä¹Ÿå«å¹³è¡¡äºŒå‰æ ‘ï¼Œç®€ç•¥çš„è¯´å°±æ˜¯<code>BST</code>å’Œé«˜åº¦å¹³è¡¡çš„äºŒå‰æ ‘çš„èåˆ</p>
<blockquote>
<p><code>BST</code>ï¼ŒäºŒå‰æœç´¢æ ‘ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä»¥æ ‘ç»“æ„å­˜å‚¨çš„å‡åºæ•°ç»„</p>
<p>é«˜åº¦å¹³è¡¡çš„äºŒå‰æ ‘ï¼Œä»»æ„èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®<code>&lt;=1</code>ï¼Œæ¯”å¦‚è¿™æ£µå°±æ˜¯<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/01a11ac9dc0c3bc1f67c7403cb1523d3.png" alt="image-20220410171609821"></p>
</blockquote>
<p><code>AVL</code>çš„é€’å½’å®šä¹‰ä¸º:</p>
<ol>
<li>æ˜¯<code>BST</code>ï¼Œä¸”å·¦å³å­æ ‘é«˜åº¦å·®çš„ç»å¯¹å€¼<code>&lt;=1</code></li>
<li>å­æ ‘ä¹Ÿæ˜¯<code>AVL</code></li>
</ol>
<blockquote>
<p><code>balance factor</code>:å¹³è¡¡å› å­ï¼Œå› ä¸º<code>AVL</code>æ˜¯é«˜åº¦å¹³è¡¡çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæŒ‡æ ‡åˆ¤æ–­æ˜¯å¦å¹³è¡¡ï¼Œåœ¨å¤±è¡¡åè§¦å‘å¹³è¡¡æ“ä½œ</p>
<p><code>BL=abs(h(n-&gt;left)-h(n-&gt;right))</code>ï¼Œå³å·¦å³å­æ ‘çš„é«˜åº¦å·®</p>
<p>åŸºäºå¹³è¡¡å› å­ï¼Œ<code>AVL</code>çš„ç¬¬äºŒæ¡å®šä¹‰å¯ä»¥ä¸º:ä»»æ„èŠ‚ç‚¹çš„å¹³è¡¡å› å­çš„ç»å¯¹å€¼<code>&lt;=1</code></p>
<p>æ ‘çš„é«˜åº¦å®šä¹‰:</p>
<blockquote>
<p>ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è·¯å¾„åŒ…å«çš„èŠ‚ç‚¹æ•°çš„æœ€å¤§å€¼(åŒ…æ‹¬æ ¹èŠ‚ç‚¹)</p>
<p><a target="_blank" rel="noopener" href="https://leetcode-cn.com/problems/maximum-depth-of-binary-tree/">leetcode</a>ï¼Œè™½ç„¶æ±‚å¾—æ˜¯æœ€å¤§æ·±åº¦ï¼Œä¸è¿‡æ·±åº¦å’Œé«˜åº¦å…¶å®å·®ä¸å¤š</p>
<p>ååºéå†:<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/2ce9c3e7010ec20c30d927cd2d5e5975.png" alt="image-20220410173756581"></p>
<p>å…ˆåºéå†:<img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-10/c853a40ef29f606d41b721cd861de3f6.png" alt="image-20220410174114294"></p>
</blockquote>
</blockquote>
<p>æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹ä¹‹åï¼Œè¦æ›´æ–°é«˜åº¦ï¼Œè¦æ›´æ–°é«˜åº¦çš„èŠ‚ç‚¹ä¸ºæ“ä½œèŠ‚ç‚¹çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹</p>
<h3 id="å¹³è¡¡"><a href="#å¹³è¡¡" class="headerlink" title="å¹³è¡¡"></a>å¹³è¡¡</h3><p>å¹³è¡¡æ˜¯è‡ªåº•è€Œä¸Šçš„ï¼Œå³ä»ç¦»æ“ä½œèŠ‚ç‚¹æœ€è¿‘çš„å¤±è¡¡çš„ç¥–å…ˆèŠ‚ç‚¹å¼€å§‹ï¼Œå¹³è¡¡æœ‰ä¸¤ç§æ“ä½œï¼Œå·¦æ—‹å’Œå³æ—‹</p>
<p>å³æ—‹:</p>
<blockquote>
<p><code>c.balanceFactor &gt; 1</code></p>
<p><img src="https://pic3.zhimg.com/80/v2-eee97a3e3e45d8cb6668841f6b44191a_720w.jpg" alt="img"></p>
<p><code>C</code>èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹éƒ½æ˜¯<code>&gt;=</code>B çš„ï¼Œæ‰€ä»¥å¯ä»¥æ¥åˆ° B çš„å³å­æ ‘ï¼Œå¦‚æœèŠ‚ç‚¹ B æœ‰å³å­æ ‘ï¼Œé€šå¸¸çš„ç­–ç•¥æ˜¯å…ˆæ–­å¼€ B çš„å³å­æ ‘ï¼Œå°† C æ¥åˆ° B çš„å³è¾¹ï¼Œç„¶åæŠŠå³å­æ ‘æ¥åˆ° C çš„å·¦è¾¹</p>
</blockquote>
<p>åŒç†ï¼Œå·¦æ—‹å’Œå³æ—‹åŸºæœ¬æ˜¯å¯¹ç§°çš„æ“ä½œ</p>
<p>æ—‹è½¬æ“ä½œä¼šæ”¹å˜æ ‘çš„ç»“æ„ï¼Œæ–¹ä¾¿èµ·è§ï¼ŒèŠ‚ç‚¹çš„ç»“æ„ä¸­<code>parent</code>ä¸ºæŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆ</p>
<p>å·¦æ—‹ç¤ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    Node* left;</span><br><span class="line">    Node* right;</span><br><span class="line">    Node* parent;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    <span class="type">int</span> factor;</span><br><span class="line">&#125;node,*nptr;</span><br><span class="line"><span class="function">node* <span class="title">LeftRotate</span><span class="params">(node* cur)</span> </span>&#123;	<span class="comment">//å·¦æ—‹cur</span></span><br><span class="line">    <span class="keyword">if</span> (!cur) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (cur-&gt;parent) &#123;</span><br><span class="line">        node* n =</span><br><span class="line">            (cur-&gt;parent-&gt;left == cur) ? cur-&gt;parent-&gt;left : cur-&gt;parent-&gt;right;</span><br><span class="line">        n = cur-&gt;right;</span><br><span class="line">        cur-&gt;right-&gt;parent = cur-&gt;parent;</span><br><span class="line">    &#125;</span><br><span class="line">    node* cr = cur-&gt;right;</span><br><span class="line">    node* crl = cr-&gt;left;</span><br><span class="line">    <span class="keyword">if</span> (crl) crl-&gt;parent = cur;</span><br><span class="line">    cur-&gt;right = crl;</span><br><span class="line">    cr-&gt;left = cur;</span><br><span class="line">    <span class="keyword">return</span> cur-&gt;parent = cr;	<span class="comment">//cur-&gt;parent=cr;return cr;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/9a705d5ca9bc82655603ccbe19cbc402.png" alt="image-20220411224513434"></p>
<p><code>x</code>æ˜¯æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶ R çš„å¹³è¡¡å› å­ä¸º<code>&gt; 1</code>ï¼Œè¿™ç§æƒ…å†µå¯ä»¥å«åš<code>LL</code>å‹ï¼ŒR çš„<strong>å·¦å­æ ‘</strong>RL çš„<strong>å·¦å­æ ‘</strong>æ–°æ’å…¥äº†èŠ‚ç‚¹ï¼Œå¹³è¡¡æ“ä½œä¸ºèŠ‚ç‚¹ R å³æ—‹</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/13bd3c2daacc4cacd35af2f113b079c5.png" alt="image-20220411224902843">ç„¶åå°±å¹³è¡¡äº† ğŸ¤ </p>
<p>å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/9a57fd7e0fff43b08f3b2b3061e5b160.png" alt="image-20220411225349437"></p>
<p>R çš„å¹³è¡¡å› å­ä»ç„¶æ˜¯ 2,ä½†æ˜¯æ’å…¥çš„èŠ‚ç‚¹åœ¨ RL çš„å³å­æ ‘ï¼Œè¿™ç§æƒ…å†µå¯ä»¥å«åš LR å‹ï¼Œéœ€è¦è¿›è¡Œä¸¤æ¬¡æ—‹è½¬æ“ä½œç„¶åå¹³è¡¡</p>
<p>é¦–å…ˆç»™ RL å·¦æ—‹:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/65c9aca259f50d0751f6b59d9492db2f.png" alt="image-20220411225739881">èªæ˜çš„ä½ ä¸€å®šå‘ç°äº†ï¼Œå·¦æ—‹ä¹‹åå˜æˆäº† LL å‹ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å†ç»™ R è¿›è¡Œä¸€æ¬¡å³æ—‹æ“ä½œ:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-11/be1b88cbb344601ef3faee1320fafe5a.png" alt="image-20220411225944026">äºæ˜¯åˆå¹³è¡¡äº†</p>
<p>å½“ç„¶ï¼ŒLR å‹åŒ…å«äº†ä¸‰ç§æƒ…å†µï¼Œè¿™é‡Œæ˜¯<code>RRR</code>èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¸º<code>-1</code>ï¼Œè¿˜æœ‰<code>0 1</code>è¿™ä¸¤ç§ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡å·¦æ—‹<code>RL</code>èŠ‚ç‚¹ï¼Œå˜æˆ<code>LL</code>å‹ï¼Œç„¶åå³æ—‹<code>R</code>æœ€ç»ˆå¹³è¡¡</p>
<p>è‡³äº<code>RR,RL</code>å‹ï¼Œå’Œ<code>LL,LR</code>æ˜¯<strong>å¯¹ç§°</strong>æ“ä½œï¼Œè¿™é‡Œä¸å†èµ˜è¿°</p>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æ‡’å¾—å†™â€¦ä»¥åè¡¥</p>
<p><code>AVL</code>ä¸æ™®é€š<code>BST</code>æœ‰åŒºåˆ«çš„æ“ä½œåœ¨äº<strong>æ’å…¥å’Œåˆ é™¤</strong>æ—¶ï¼Œéœ€è¦å¯¹å¯èƒ½å—å½±å“çš„èŠ‚ç‚¹å¹³è¡¡ï¼Œå¯èƒ½å—å½±å“çš„èŠ‚ç‚¹ï¼Œå®é™…ä¸Šå°±æ˜¯æ“ä½œèŠ‚ç‚¹çš„æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œå› ä¸ºè¿™äº›èŠ‚ç‚¹çš„å¹³è¡¡å› å­ä¼šå‘ç”Ÿå˜åŒ–(å­æ ‘é«˜åº¦å˜äº†)</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>å®é™…ä¸Šï¼Œ<code>AVL</code>å°±æ˜¯ä¸€æ£µç‰¹æ®Šçš„<code>BST</code>ï¼Œåªæ˜¯å¯¹é«˜åº¦è¿›è¡Œäº†é™åˆ¶ï¼Œé‚£ä¹ˆï¼Œ<code>AVL</code>çš„åº”ç”¨åœºæ™¯åœ¨ä»€ä¹ˆåœ°æ–¹æï¼Ÿ</p>
<p>ä¼ ç»Ÿçš„<code>BST</code>å¾ˆå®¹æ˜“é€€åŒ–æˆä¸€æ¡é“¾ï¼Œè¿™æ—¶çš„æŸ¥æ‰¾å¤æ‚åº¦å°±å˜æˆäº†<code>O(n)</code>ï¼Œè€Œ<code>AVL</code>é€šè¿‡å¹³è¡¡ï¼Œä¿è¯æ ‘æ•´ä½“ç»“æ„ç›¸å¯¹å¯¹ç§°ï¼ŒæŸ¥æ‰¾å¤æ‚åº¦æ€»æ˜¯<code>O(logn)</code></p>
<p>ä¸è¿‡ç”±äºå¹³è¡¡æ“ä½œå¾ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥åªé€‚åˆå°‘é‡å¢åˆ èŠ‚ç‚¹ï¼Œå¤§é‡æŸ¥è¯¢çš„åœºæ™¯</p>
<h2 id="B-tree"><a href="#B-tree" class="headerlink" title="B tree"></a>B tree</h2><p>B ä½ å¦ˆ</p>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><h2 id="Part-1-Introduction-and-Setting-up-the-REPL"><a href="#Part-1-Introduction-and-Setting-up-the-REPL" class="headerlink" title="Part 1-Introduction and Setting up the REPL"></a>Part 1-Introduction and Setting up the REPL</h2><p>ä½œä¸ºä¸€ä¸ªç½‘ç»œå¼€å‘è€…ï¼Œæˆ‘æ¯å¤©éƒ½åœ¨å·¥ä½œä¸­ä½¿ç”¨å…³è”æ€§æ•°æ®åº“ï¼Œä½†æ˜¯å®ƒä»¬å¯¹äºæˆ‘æ¥è¯´æ˜¯ä¸€ä¸ªé»‘ç›’å­.æˆ‘æœ‰ä¸€äº›ç–‘æƒ‘:</p>
<ul>
<li>æ•°æ®å­˜å‚¨å½¢å¼æ˜¯ä»€ä¹ˆï¼Ÿ(å†…å­˜å’Œç£ç›˜)</li>
<li>æ•°æ®ä»€ä¹ˆæ—¶å€™ä»å†…å­˜ä¸­ç§»åŠ¨åˆ°ç£ç›˜ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆæ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªä¸» keyï¼Ÿ</li>
<li>å›æ»šäº‹åŠ¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</li>
<li>ç´¢å¼•æ˜¯å¦‚ä½•æ ¼å¼åŒ–çš„ï¼Ÿ</li>
<li>å…¨è¡¨æ‰«æä½•æ—¶ä»¥åŠå¦‚ä½•å‘ç”Ÿï¼Ÿ</li>
<li>å³å°†æ‰§è¡Œçš„è¯­å¥ä»¥ä»€ä¹ˆæ ¼å¼å‚¨å­˜ï¼Ÿ</li>
</ul>
<p>æ¢å¥è¯è¯´å°±æ˜¯ï¼Œæ•°æ®åº“æ˜¯å¦‚ä½• <strong>å·¥ä½œ</strong> çš„ï¼Ÿ</p>
<p>ä¸ºäº†æŠŠäº‹æƒ…å¼„æ¸…æ¥šï¼Œæˆ‘æ­£åœ¨ä»å¤´å¼€å§‹å†™ä¸€ä¸ªæ•°æ®åº“.å®ƒä»¥ sqlite ä¸ºæ¨¡æ¿ï¼Œå› ä¸ºå®ƒè¢«è®¾è®¡ä¸ºå°ä½“ç§¯ï¼ŒåŠŸèƒ½æ¯” MySql æˆ– PostgreSQL å°‘ï¼Œæ‰€ä»¥æˆ‘æ›´æœ‰å¸Œæœ›ç†è§£å®ƒ.æ•´ä¸ªæ•°æ®åº“è¢«å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­!</p>
<h3 id="Sqlite"><a href="#Sqlite" class="headerlink" title="Sqlite"></a>Sqlite</h3><p>åœ¨ Sqlite ç½‘ç«™ä¸Šæœ‰è®¸å¤š <a target="_blank" rel="noopener" href="https://www.sqlite.org/arch.html">å…³äº sqilite çš„å†…éƒ¨ç»“æ„çš„æ–‡ç« </a>ï¼Œæ­¤å¤–æˆ‘æœ‰ä¸€ä»½èµ„æ–™<a target="_blank" rel="noopener" href="https://play.google.com/store/books/details?id=9Z6IQQnX1JEC">SQLite Database System:Design and Implementation</a>.</p>
<p>sqlite ç»“æ„(<a target="_blank" rel="noopener" href="https://www.sqlite.org/zipvfs/doc/trunk/www/howitworks.wiki">howitworks.wiki</a>)</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch1.gif" alt="img"></p>
<p>ä¸€æ¬¡æŸ¥è¯¢é€šè¿‡ä¸€ç³»åˆ—ç»„ä»¶æ¥æ£€ç´¢æˆ–ä¿®æ”¹æ•°æ®.<strong>å‰ç«¯</strong> åŒ…æ‹¬:</p>
<ul>
<li>tokenizer</li>
<li>parser</li>
<li>code generator</li>
</ul>
<p>å‰ç«¯çš„è¾“å…¥æ˜¯ä¸€ä¸ª SQL æŸ¥è¯¢ï¼Œè¾“å‡ºæ˜¯ sqlite è™šæ‹Ÿå­—èŠ‚ç (æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯è¢«æ•°æ®åº“æ‰§è¡Œçš„ç¼–è¯‘ç¨‹åº).</p>
<p><strong>åç«¯</strong> åŒ…æ‹¬:</p>
<ul>
<li>virtual machine</li>
<li>B-tree</li>
<li>pager</li>
<li>os interface</li>
</ul>
<p><strong>è™šæ‹Ÿæœº</strong> å°†å‰ç«¯ç”Ÿæˆçš„å­—èŠ‚ç å½“ä½œæŒ‡ä»¤.å®ƒå¯ä»¥åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨æ ¼æˆ–ç´¢å¼•ä¸Šæ‰§è¡Œæ“ä½œï¼Œæ¯ä¸ªè¡¨æˆ–ç´¢å¼•éƒ½è¢«å­˜å‚¨åœ¨ä¸€ä¸ªå«åš<code>B-tree</code>çš„æ•°æ®ç»“æ„ä¸­.è™šæ‹Ÿæœºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª switch è¯­å¥ï¼Œæ¡ä»¶æ˜¯å­—èŠ‚ç æŒ‡ä»¤.</p>
<p>æ¯ä¸ª<code>B-tree</code>åŒ…æ‹¬è®¸å¤šèŠ‚ç‚¹.æ¯ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ä¸ºä¸€é¡µ.<code>B-tree</code>å¯ä»¥ä»ç£ç›˜ä¸­è¯»å–ä¸€é¡µæˆ–è€…é€šè¿‡å‘<code>pager</code>å‘å‡ºæŒ‡ä»¤ç„¶åå°†ä¸€é¡µå­˜å‚¨åˆ°ç£ç›˜ä¸Š.</p>
<p><strong>pager</strong> æ¥æ”¶å‘½ä»¤ä»¥è¯»å–æˆ–å†™å…¥æ•°æ®é¡µ.å®ƒè´Ÿè´£åœ¨åˆé€‚çš„ä½ç½®è¯»å–&#x2F;å†™å…¥æ•°æ®ï¼Œè¿˜å°†æœ€è¿‘è·å–çš„å‡ é¡µçš„ç¼“å­˜ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¹¶ä¸”å†³å®šé‚£äº›é¡µä½•æ—¶è¢«å†™å›ç£ç›˜.</p>
<p><strong>os interface(ç³»ç»Ÿæ¥å£)</strong> å±‚æ ¹æ® sqlite è¢«ç¼–è¯‘çš„å¹³å°è€Œæœ‰æ‰€åŒºåˆ«.åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä¸æ‰“ç®—æ”¯æŒå¤šä¸ªæ“ä½œç³»ç»Ÿ.</p>
<p><a target="_blank" rel="noopener" href="https://en.wiktionary.org/wiki/a_journey_of_a_thousand_miles_begins_with_a_single_step">åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹</a>ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»¥æ›´ç›´æ¥çš„æ–¹å¼å¼€å§‹:<code>the REPL(read-eval-print loop)</code></p>
<h3 id="Making-a-Simple-REPL"><a href="#Making-a-Simple-REPL" class="headerlink" title="Making a Simple REPL"></a>Making a Simple REPL</h3><p>å½“ä»å‘½ä»¤è¡Œæ‰§è¡Œ sqlite æ—¶ï¼Œä¼šè¿›å…¥ä¸€ä¸ªè¯»å–-æ‰§è¡Œ-è¾“å‡ºå¾ªç¯:</p>
<blockquote>
<p>~ sqlite3<br>SQLite version 3.16.0 2016-11-04 19:09:39<br>Enter â€œ.helpâ€ for usage hints.<br>Connected to a transient in-memory database.<br>Use â€œ.open FILENAMEâ€ to reopen on a persistent database.<br>sqlite&gt; create table users (id int, username varchar(255), email varchar(255));<br>sqlite&gt; .tables<br>users<br>sqlite&gt; .exit<br>~</p>
</blockquote>
<p>ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬çš„ main å‡½æ•°å°†ä¼šæœ‰ä¸€ä¸ªæ— æ­¢å¢ƒçš„å¾ªç¯ï¼Œæ‰“å°æç¤ºï¼Œè·å–ä¸€è¡Œè¾“å…¥ï¼Œç„¶åæ‰§è¡Œè¿™è¡Œè¾“å…¥:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">print_prompt</span>();</span><br><span class="line">    <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cout&lt;&lt;<span class="string">&quot;Unrecognized command &quot;</span>&lt;&lt;</span><br><span class="line">          &lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°†<code>InputBuffer</code>å®šä¹‰ä¸ºä¸€ä¸ªå°åŒ…è£…å™¨ä»¥ä¾¿å­˜å‚¨å’Œ<code>getline</code>(<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man3/getline.3.html">ref</a>)äº¤äº’æ—¶çš„çŠ¶æ€.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="type">char</span>* buffer;</span><br><span class="line">	<span class="type">size_t</span> buffer_length;</span><br><span class="line">	<span class="type">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span></span>&#123;</span><br><span class="line">	InputBuffer* input_buffer=InputBuffer* <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">	input_buffer-&gt;buffer=<span class="literal">NULL</span>;</span><br><span class="line">	input_buffer-&gt;buffer_length=<span class="number">0</span>;</span><br><span class="line">	input_buffer-&gt;input_length=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶å,<code>print_prompt()</code>ç»™ç”¨æˆ·æ‰“å°æç¤ºï¼Œåœ¨è¯»å–ä¸€è¡Œè¾“å…¥ä¹‹å‰.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_prompt</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;db &gt; &quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è¯»å–ä¸€è¡Œè¾“å…¥ï¼Œä½¿ç”¨<a target="_blank" rel="noopener" href="http://man7.org/linux/man-pages/man3/getline.3.html">getline</a>:</p>
<p><code>ssize_t getline(char **lineptr,size_t *n,FILE *stream);</code></p>
<p><code>lineptr</code>:ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ç”¨æ¥æŒ‡å‘åŒ…å«è¯»å–çš„è¡Œçš„ç¼“å†²åŒºçš„å˜é‡.å¦‚æœåœ¨è°ƒç”¨<code>getline()</code>ä¹‹å‰<code>*lineptr</code>è¢«è®¾ä¸º<code>NULL</code>ï¼Œé‚£ä¹ˆ<code>getline()</code>å°†ä¼šåˆ†é…ä¸€ä¸ªç¼“å†²åŒºç”¨æ¥å­˜å‚¨è¡Œï¼Œè¿™ä¸ªç¼“å†²åŒºåº”è¯¥ç”±ç”¨æˆ·é‡Šæ”¾ï¼Œå³ä½¿<code>getline()</code>è°ƒç”¨å¤±è´¥.</p>
<p><code>n</code>:ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ç”¨æ¥å­˜å‚¨åˆ†é…çš„ç¼“å†²åŒºçš„å¤§å°çš„å˜é‡.</p>
<p><code>stream</code>:ç”¨æ¥è¯»å–çš„è¾“å…¥æµ.æˆ‘ä»¬å°†ä»æ ‡å‡†è¾“å…¥æµä¸­è¯»å–.</p>
<p><code>return value</code>:è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯èƒ½å°äºç¼“å†²åŒºçš„å¤§å°.</p>
<p>æˆ‘ä»¬è®©<code>getline</code>è¯»å–çš„è¡Œå­˜å‚¨åœ¨<code>input_buffer-&gt;buffer</code>ï¼Œç¼“å†²åŒºå¤§å°æ˜¯<code>input_buffer-&gt;buffer_length</code>ï¼Œè¿”å›å€¼å­˜å‚¨åœ¨<code>input_buffer-&gt;input_length</code></p>
<p><code>buffer</code>çš„åˆå§‹å€¼ä¸ºnullï¼Œæ‰€ä»¥<code>getline</code>ä¼šåˆ†é…è¶³å¤Ÿçš„ç©ºé—´æ¥ä¿å­˜è¾“å…¥è¡Œï¼Œç„¶åè®©<code>buffer</code>æŒ‡å‘è¯¥ç©ºé—´.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="type">ssize_t</span> bytes_read =</span><br><span class="line">      <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), stdin);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);	<span class="comment">//define EXIT_FAILURE 1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¿½ç•¥æ¢è¡Œç¬¦</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;	<span class="comment">//cè¯­è¨€å­—ç¬¦ä¸²ç»“æŸæ ‡å¿—ä¸º&#x27;\0&#x27;,æ•°å€¼ä¸º0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ˜¯æ—¶å€™å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨æ¥é‡Šæ”¾åˆ†é…ç»™<code>InputBuffer *</code>å®ä¾‹ä»¥åŠæˆå‘˜å˜é‡<code>buffer</code>çš„ç©ºé—´äº†(è°ƒç”¨<code>read_input</code>çš„æ—¶å€™<code>getline</code>ç»™<code>input_buffer-&gt;buffer</code>åˆ†é…äº†å†…å­˜).</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span></span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);	<span class="comment">//æ˜¾ç„¶,æ˜¯ç”¨å †åˆ†é…çš„ç©ºé—´</span></span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œè§£æç„¶åæ‰§è¡Œå‘½ä»¤.ç›®å‰åªæœ‰ä¸€ä¸ªå‘½ä»¤å¯ä»¥è¢«è¯†åˆ«:<code>.exit</code>ï¼Œç”¨æ¥ç»ˆæ­¢ç¨‹åºï¼Œå¦‚æœä¸æ˜¯<code>.exit</code>å°±æ‰“å°é”™è¯¯æ¶ˆæ¯ç„¶åç»§ç»­å¾ªç¯.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">  <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°è¯•è¿è¡Œå®ƒå§~</p>
<blockquote>
<p>~ .&#x2F;db<br>db &gt; .tables<br>Unrecognized command â€˜.tablesâ€™.<br>db &gt; .exit<br>~</p>
</blockquote>
<p>å¥½äº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæœ‰ç”¨çš„REPL.åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œå°†è¦å¼€å‘æˆ‘ä»¬çš„å‘½ä»¤è¯­è¨€.</p>
<p>é¡ºä¾¿ï¼Œè¿™æ˜¯è¿™éƒ¨åˆ†çš„å…¨éƒ¨ä»£ç :</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="type">char</span>* buffer;</span><br><span class="line">  <span class="type">size_t</span> buffer_length;</span><br><span class="line">  <span class="type">ssize_t</span> input_length;</span><br><span class="line">&#125; InputBuffer;</span><br><span class="line"></span><br><span class="line"><span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">  input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">  input_buffer-&gt;buffer_length = <span class="number">0</span>;</span><br><span class="line">  input_buffer-&gt;input_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> input_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_prompt</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;db &gt; &quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_input</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="type">ssize_t</span> bytes_read =</span><br><span class="line">      <span class="built_in">getline</span>(&amp;(input_buffer-&gt;buffer), &amp;(input_buffer-&gt;buffer_length), stdin);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_read &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error reading input\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ignore trailing newline</span></span><br><span class="line">  input_buffer-&gt;input_length = bytes_read - <span class="number">1</span>;</span><br><span class="line">  input_buffer-&gt;buffer[bytes_read - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(input_buffer-&gt;buffer);</span><br><span class="line">    <span class="built_in">free</span>(input_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">print_prompt</span>();</span><br><span class="line">    <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Part-2-Worldâ€™s-Simplest-SQL-Compiler-and-Virtual-Machine"><a href="#Part-2-Worldâ€™s-Simplest-SQL-Compiler-and-Virtual-Machine" class="headerlink" title="Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine"></a>Part 2 - Worldâ€™s Simplest SQL Compiler and Virtual Machine</h2><p>æˆ‘ä»¬æ­£åœ¨å…‹éš†ä¸€ä»½sqlite.sqliteçš„<strong>å‰ç«¯</strong>æ˜¯ä¸€ä¸ªSQLç¼–è¯‘å™¨ï¼Œç”¨æ¥è§£æè¾“å…¥çš„å­—ç¬¦ä¸²ç„¶åè¾“å‡ºä¸€ç§å«åš<code>bytecode</code>(å­—èŠ‚ç )çš„å†…éƒ¨è¡¨ç¤º.</p>
<p>bytecodeè¢«ä¼ å…¥è™šæ‹Ÿæœº,ç„¶åç”±è™šæ‹Ÿæœºæ‰§è¡Œ.</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch2.gif" alt="img"></p>
<p>å°†äº‹æƒ…åˆ†æˆè¿™æ ·çš„ä¸¤æ­¥æœ‰2ä¸ªå¥½å¤„:</p>
<ul>
<li>å‡å°‘æ¯ä¸€éƒ¨åˆ†çš„å¤æ‚æ€§(e.g. è™šæ‹Ÿæœºä¸å…³å¿ƒè¯­æ³•é”™è¯¯)</li>
<li>Allows compiling common queries once and caching the bytecode for improved performance.</li>
</ul>
<p>è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬é‡æ„mainå‡½æ•°å¹¶ä¸”åœ¨è¿‡ç¨‹ä¸­æ”¯æŒä¸¤ä¸ªæ–°çš„å…³é”®è¯:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer)) &#123;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          cout&lt;&lt;<span class="string">&quot;Unrecognized command: &quot;</span>&lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        cout&lt;&lt;<span class="string">&quot;Unrecognized keyword at start of: &quot;</span>&lt;&lt;input_buffer-&gt;buffer&lt;&lt;endl;</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="built_in">execute_statement</span>(&amp;statement);</span><br><span class="line">+    cout&lt;&lt;<span class="string">&quot;Executed.&quot;</span>&lt;&lt;endl;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>éSQLè¯­å¥åƒæ˜¯<code>.exit</code>è¢«ç§°ä½œ <strong>å…ƒå‘½ä»¤</strong>.å…ƒå‘½ä»¤ä»¥<code>.</code>å¼€å§‹,å› æ­¤æˆ‘ä»¬æ£€æŸ¥å¹¶åœ¨å•ç‹¬çš„å‡½æ•°ä¸­å¤„ç†å…ƒå‘½ä»¤.</p>
<p>ç„¶åï¼ŒåŠ ä¸€æ­¥ç”¨æ¥æŠŠè¾“å…¥è¡Œè½¬æ¢ä¸ºè¯­å¥çš„å†…éƒ¨è¡¨ç¤º.This is our hacky version of the sqlite front-end.</p>
<p>æœ€åï¼ŒæŠŠå‡†å¤‡å¥½çš„è¯­å¥ä¼ é€’ç»™<code>execute_statement</code>.è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šæˆä¸ºæˆ‘ä»¬çš„è™šæ‹Ÿæœº.</p>
<p>æ³¨æ„ä¸¤ä¸ªæ–°å‡½æ•°è¿”å›çš„æ˜¯è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥çš„æšä¸¾å˜é‡:</p>
<blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">  META_COMMAND_SUCCESS,</span><br><span class="line">  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">&#125; MetaCommandResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>â€œUnrecognized statementâ€?è¿™æœ‰ç‚¹åƒä¸€ä¸ª exception.æˆ‘ä¸å¤ªå–œæ¬¢ä½¿ç”¨exception(è€Œä¸”Cç”šè‡³éƒ½ä¸æ”¯æŒ)ï¼Œæ‰€ä»¥æˆ‘åœ¨ä»»ä½•å¯è¡Œçš„åœ°æ–¹éƒ½æ˜¯ç”¨<code>enum result code</code>.å¦‚æœswitchè¯­å¥æ²¡æœ‰å¤„ç†å…¶ä¸­ä¸€ä¸ªæšä¸¾æˆå‘˜ï¼ŒCç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ›´æœ‰ä¿¡å¿ƒåœ°å¤„ç†å‡½æ•°çš„æ¯ä¸ªç»“æœ.é¢„è®¡æœªæ¥ä¼šæ·»åŠ æ›´å¤š<code>result code</code>.</p>
<p>do_meta_commandåªæ˜¯ç°æœ‰åŠŸèƒ½çš„ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨æ¥ç»™æ›´å¤šå‘½ä»¤é¢„ç•™ç©ºé—´.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›®å‰çš„<code>prepared statement</code>åªåŒ…å«ä¸€ä¸ªæœ‰ä¸¤ä¸ªæˆå‘˜çš„æšä¸¾å˜é‡ï¼Œå› ä¸ºæˆ‘ä»¬å…è®¸statementsæœ‰å‚æ•°ï¼Œå®ƒå°†åŒ…å«æ›´å¤šæ•°æ®.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  StatementType type;</span><br><span class="line">&#125; Statement;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>prepare_statement(æˆ‘ä»¬çš„â€SQLç¼–è¯‘å™¨â€)ç°åœ¨è¿˜ä¸èƒ½ç†è§£SQLè¯­å¥.å®é™…ä¸Šå®ƒåªèƒ½ç†è§£ä¸¤ä¸ªè¯:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Statement* statement)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>strncmp</code>æ¥æ¯”è¾ƒå­—ç¬¦ä¸²å› ä¸º<code>insert</code>å•è¯åé¢è·Ÿç€æ•°æ®.(e.g. <code>insert 1 cstack foo@bar.com</code>)</p>
<p>æœ€å,<code>execute_statement</code>åŒ…å«ä¸€äº›stubs:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">    <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do an insert.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do a select.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„å‡½æ•°ä¸è¿”å›ä»»ä½•é”™è¯¯ç ,å› ä¸ºç›®å‰è¿˜ä¸ä¼šå‡ºç°é”™è¯¯.</p>
<p>é‡æ„ä¹‹åï¼Œç°åœ¨å¯ä»¥è¯†åˆ«ä¸¤ä¸ªæ–°å…³é”®å­—äº†!</p>
<blockquote>
<p>~ .&#x2F;db<br>db &gt; insert foo bar<br>This is where we would do an insert.<br>Executed.<br>db &gt; delete foo<br>Unrecognized keyword at start of â€˜delete fooâ€™.<br>db &gt; select<br>This is where we would do a select.<br>Executed.<br>db &gt; .tables<br>Unrecognized command â€˜.tablesâ€™<br>db &gt; .exit<br>~</p>
</blockquote>
<p>æˆ‘ä»¬æ•°æ®åº“ç¨‹åºçš„éª¨æ¶æ­£åœ¨é€æ­¥æ„å»ºâ€¦å¦‚æœå®ƒèƒ½å¤Ÿå­˜å‚¨æ•°æ®é‚£ä¸æ˜¯æ›´å¥½å—?åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†ä¼šå®ç°<code>insert</code>å’Œ<code>select</code>,åˆ›å»ºä¸–ç•Œä¸Šæœ€ç³Ÿç³•~çš„æ•°æ®å­˜å‚¨.é¡ºä¾¿ï¼Œè¿™é‡Œæœ‰æœ¬ç« çš„æ‰€æœ‰æ”¹åŠ¨:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@@ <span class="number">-10</span>,<span class="number">6</span> +<span class="number">10</span>,<span class="number">23</span> @@ <span class="keyword">struct</span> <span class="title class_">InputBuffer_t</span> &#123;</span><br><span class="line"> &#125; InputBuffer;</span><br><span class="line"> </span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  META_COMMAND_SUCCESS,</span><br><span class="line">+  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">+&#125; MetaCommandResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; PREPARE_SUCCESS, PREPARE_UNRECOGNIZED_STATEMENT &#125; PrepareResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  StatementType type;</span><br><span class="line">+&#125; Statement;</span><br><span class="line">+</span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">   input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">@@ <span class="number">-40</span>,<span class="number">17</span> +<span class="number">57</span>,<span class="number">67</span> @@ <span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do an insert.\n&quot;</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do a select.\n&quot;</span>);</span><br><span class="line">+      <span class="keyword">break</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"> </span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer)) &#123;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="built_in">execute_statement</span>(&amp;statement);</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Part3-An-In-Memory-Append-Only-Single-Table-Database"><a href="#Part3-An-In-Memory-Append-Only-Single-Table-Database" class="headerlink" title="Part3 - An In-Memory,Append-Only,Single-Table Database"></a>Part3 - An In-Memory,Append-Only,Single-Table Database</h2><p>æˆ‘ä»¬å…ˆå®ç°æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œå¹¶ç»™æ•°æ®åº“æ·»åŠ ä¸€äº›é™åˆ¶.ç›®å‰æ¥è¯´ï¼Œæ•°æ®åº“å°†:</p>
<ul>
<li>æ”¯æŒä¸¤ç§æ“ä½œ: æ’å…¥ä¸€è¡Œç„¶åæ‰“å°æ‰€æœ‰è¡Œ.</li>
<li>åªä¿å­˜åœ¨å†…å­˜ä¸­(è€Œä¸æ˜¯ç£ç›˜)</li>
<li>æ”¯æŒå•ä¸ªï¼Œç¡¬ç¼–ç çš„è¡¨</li>
</ul>
<p>æˆ‘ä»¬çš„ç¡¬ç¼–ç è¡¨å°†ä¼šå­˜å‚¨ç”¨æˆ·ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-21/4c36e008a593cad02a5f4052452488ab.png" alt="image-20220421000123610"></p>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼Œä½†æ˜¯æ”¯æŒå¤šç§æ•°æ®ç±»å‹å’Œé•¿åº¦å¯å˜çš„å­—ç¬¦ä¸².</p>
<p><code>insert</code>è¯­å¥çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<p><code>insert 1 cstack foo@bar.com</code></p>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦æ‰©å±•<code>prepare_statement</code>å‡½æ•°ä»¥è§£æå‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">+        input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">+        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">+    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+    &#125;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æŠŠè§£æå¾—åˆ°çš„å‚æ•°æ”¾è¿›statementå¯¹è±¡çš„æ–°æˆå‘˜Rowä¸­.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">uint32_t</span> id;</span><br><span class="line">+  <span class="type">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">+  <span class="type">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+&#125; Row;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   StatementType type;</span><br><span class="line">+  Row row_to_insert;  <span class="comment">// only used by insert statement</span></span><br><span class="line"> &#125; Statement;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦æŠŠæ•°æ®æ‹·è´åˆ°è¡¨ç¤ºè¡¨çš„æ•°æ®ç»“æ„ä¸­.SQLiteä½¿ç”¨<code>B-tree</code>ä»¥å®ç°å¿«é€ŸæŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤.æˆ‘ä»¬ä¸€å¼€å§‹å…ˆç”¨ç®€å•ç‚¹çš„æ•°æ®ç»“æ„.ç±»ä¼¼ä¸€æ£µ<code>B-tree</code>ï¼Œå®ƒå°†è¡Œå­˜è¿›é¡µä¸­ï¼Œä½†æ˜¯é¡µå¹¶ä¸ä»¥æ ‘çš„å½¢å¼ç»„ç»‡ï¼Œè€Œæ˜¯ä»¥åˆ—è¡¨çš„å½¢å¼.</p>
<p>è¿™æ˜¯æˆ‘çš„æƒ³æ³•:</p>
<ul>
<li>å°†è¡Œå­˜å‚¨åœ¨å«åšé¡µçš„å†…å­˜å—</li>
<li>æ¯ä¸€é¡µå­˜å‚¨å°½å¯èƒ½å¤šçš„è¡Œ</li>
<li>æ¯ä¸€é¡µä¸­è¡Œè¢«åºåˆ—åŒ–æˆç´§å‡‘çš„è¡¨ç°å½¢å¼</li>
<li>é¡µåªåœ¨éœ€è¦çš„æ—¶å€™åˆ†é…</li>
<li>ç»´æŠ¤ä¸€ä¸ªå®šé•¿æ•°ç»„ï¼Œæ•°ç»„æ•°æ®æ˜¯æŒ‡å‘é¡µçš„æŒ‡é’ˆ</li>
</ul>
<p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰è¡Œçš„ç´§å‡‘çš„è¡¨ç°å½¢å¼:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="meta">#<span class="keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line">+</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_OFFSET = ID_OFFSET + ID_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_OFFSET = USERNAME_OFFSET + USERNAME_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ROW_SIZE = ID_SIZE + USERNAME_SIZE + EMAIL_SIZE;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯‘è€…æ³¨:</p>
<p>å¯¹äºé‚£ä¸ªå¥‡å½¢æ€ªçŠ¶çš„å®    <code>#define size_of_attribute(Struct,Attribute)</code></p>
<p>ä½œç”¨æ˜¯è®¡ç®—ç»“æ„ä½“æˆå‘˜å˜é‡çš„å¤§å°</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå®å±•å¼€åä¼šæ˜¯è¿™æ ·:</p>
<p><code>sizeof(((Row*)0)-&gt;email)</code></p>
<p>0è¢«å¼ºåˆ¶è½¬åŒ–ä¸ºRowæŒ‡é’ˆï¼Œç„¶å0å°±å¯ä»¥è®¿é—®æˆå‘˜å˜é‡.</p>
<p>è¿™ä¸ªæ“ä½œä¸ä¼šåˆ›å»ºç»“æ„ä½“å®ä½“ï¼Œå› ä¸ºæ²¡æœ‰ç”¨<code>malloc</code>å¼€è¾Ÿç©ºé—´ï¼Œæ‰€ä»¥0å®é™…ä¸Šæ˜¯ä¸€ä¸ªé‡æŒ‡é’ˆï¼Œä½†æ˜¯<code>sizeof</code>ä¸åœ¨ä¹æ˜¯å¦é‡æŒ‡é’ˆï¼Œå®ƒåªéœ€è¦<strong>æŒ‡é’ˆæŒ‡å‘çš„å˜é‡ç±»å‹</strong>å°±å¯ä»¥åˆ¤æ–­å‡ºå¤§å°.(sizeofåœ¨ç¼–è¯‘æ—¶è¿è¡Œ)</p>
</blockquote>
<p>è¿™æ„å‘³ç€ä¸€ä¸ªåºåˆ—åŒ–çš„è¡Œçš„å¸ƒå±€çœ‹èµ·æ¥åƒè¿™æ ·:</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-21/a918324620a1ce8041b3e17ef971f96e.png" alt="image-20220421235558542"></p>
<p>We also need code to convert to and from the compact representation.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function"><span class="type">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, <span class="type">void</span>* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">deserialize_row</span><span class="params">(<span class="type">void</span>* source, Row* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;id), source + ID_OFFSET, ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;username), source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;email), source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå®šä¹‰Tableç»“æ„ä½“,æŒ‡å‘å­˜å‚¨ç€è¡Œçš„é¡µï¼Œä»¥åŠè¿½è¸ªæ€»è¡Œæ•°:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / ROW_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> TABLE_MAX_ROWS = ROWS_PER_PAGE * TABLE_MAX_PAGES;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">uint32_t</span> num_rows;</span><br><span class="line">+  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Table;</span><br></pre></td></tr></table></figure>

<p>æ¯é¡µå¤§å°ä¸º4KB,å› ä¸ºè¿™å’Œå¤§å¤šæ•°è®¡ç®—æœºæ¶æ„çš„è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä½¿ç”¨çš„é¡µä¸€è‡´.ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ•°æ®åº“çš„é¡µå¤§å°å’Œæ“ä½œç³»ç»Ÿä½¿ç”¨çš„é¡µå¤§å°ç›¸åŒ.æ“ä½œç³»ç»Ÿå°†ä¼šä»¥å®Œæ•´çš„å•å…ƒå°†é¡µç§»å…¥å’Œç§»å‡ºå†…å­˜ï¼Œè€Œä¸æ˜¯æ‹†æ•£å®ƒä»¬.</p>
<p>æˆ‘æŠŠæœ€å¤§åˆ†é…çš„é¡µçš„æ•°é‡è®¾ç½®ä¸ºä¸€ä¸ªéšæ„çš„æ•°å­—-100.å½“æˆ‘ä»¬åˆ‡æ¢åˆ°<code>B-Tree</code>ç»“æ„åï¼Œæˆ‘ä»¬æ•°æ®åº“çš„æœ€å¤§å¤§å°å°†ä»…å—é™äºä¸€ä¸ªæ–‡ä»¶çš„æœ€å¤§å¤§å°.(å°½ç®¡æˆ‘ä»¬ä»ä¼šé™åˆ¶åœ¨å†…å­˜ä¸­çš„é¡µçš„æ•°é‡)</p>
<p>è¡Œä¸åº”è¯¥ç©¿è¿‡é¡µçš„è¾¹ç•Œ.å› ä¸ºé¡µåœ¨å†…å­˜ä¸­çš„ä½ç½®å¾ˆå¯èƒ½ä¸æ˜¯å½¼æ­¤ç›¸é‚»çš„ï¼Œè¿™ä¸ªå‡è®¾è®©å†™å…¥&#x2F;è¯»å–è¡Œæ›´å®¹æ˜“äº›.(æ³¨: ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œå¦‚æœæ¯é¡µè¡Œæ•°ä¸æ˜¯å‘ä¸‹å–æ•´ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€è¡Œè¢«åˆ†å‰²åˆ°äº†é€»è¾‘ä¸Šç›¸è¿çš„ä¸¤é¡µä¸Šï¼Œä½†ç”±äºé¡µçš„ç©ºé—´æ˜¯<code>malloc</code>å‡½æ•°åˆ†é…çš„ï¼Œå› æ­¤ç‰©ç†åœ°å€ä¸ä¸€å®šç›¸è¿ï¼Œéœ€è¦é¢å¤–å¤„ç†è¿™ç§æƒ…å†µ.)</p>
<p>è¯´åˆ°è¡Œçš„è¯»å†™ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å¦‚ä½•ç¡®å®šåœ¨å†…å­˜çš„ä»€ä¹ˆä½ç½®è¯»å–&#x2F;å†™å…¥å…·ä½“è¡Œ:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function"><span class="type">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="type">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">+  <span class="type">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">+  <span class="type">void</span>* page = table-&gt;pages[page_num];</span><br><span class="line">+  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">+    page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="type">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="type">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">+  <span class="keyword">return</span> page + byte_offset;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯å®ç°<code>execute_statement</code>å‡½æ•°,å¯ä»¥ä»tableç»“æ„ä½“è¯»å–&#x2F;å†™å…¥æ•°æ®.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">-<span class="function"><span class="type">void</span> <span class="title">execute_statement</span><span class="params">(Statement* statement)</span> </span>&#123;</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS) &#123;</span><br><span class="line">+    <span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">+</span><br><span class="line">+  <span class="built_in">serialize_row</span>(row_to_insert, <span class="built_in">row_slot</span>(table, table-&gt;num_rows));</span><br><span class="line">+  table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  Row row;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; table-&gt;num_rows; i++) &#123;</span><br><span class="line">+    <span class="built_in">deserialize_row</span>(<span class="built_in">row_slot</span>(table, i), &amp;row);</span><br><span class="line">+    <span class="built_in">print_row</span>(&amp;row);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">     <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do an insert.\n&quot;</span>);</span><br><span class="line">-      <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">return</span> <span class="built_in">execute_insert</span>(statement, table);</span><br><span class="line">     <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;This is where we would do a select.\n&quot;</span>);</span><br><span class="line">-      <span class="keyword">break</span>;</span><br><span class="line">+      <span class="keyword">return</span> <span class="built_in">execute_select</span>(statement, table);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨: åŸä½œè€…å¥½åƒæ¼äº†<code>enum ExecuteResult</code>è€Œ<code>print_row()</code></p>
<p>è¡¥ä¸Š(æˆ‘è‡ªå·±çš„å®ç°)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span>&#123;</span><br><span class="line">    EXECUTE_SUCCESS,</span><br><span class="line">    EXECUTE_TABLE_FULL</span><br><span class="line">&#125; ExecuteResult;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;ID: &quot;</span>&lt;&lt;row-&gt;id&lt;&lt;endl</span><br><span class="line">    &lt;&lt;<span class="string">&quot;username: &quot;</span>&lt;&lt;row-&gt;username&lt;&lt;endl</span><br><span class="line">    &lt;&lt;<span class="string">&quot;emal: &quot;</span>&lt;&lt;row-&gt;email&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–åˆ—è¡¨ï¼Œåˆ›å»ºå„è‡ªçš„å†…å­˜é‡Šæ”¾å‡½æ•°ä»¥åŠå¤„ç†ä¸€äº›é”™è¯¯æƒ…å†µ:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+ <span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+  Table* table = (Table*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Table));</span><br><span class="line">+  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+     table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> table;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++) &#123;</span><br><span class="line">+	<span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">+  Table* table = <span class="built_in">new_table</span>();</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">@@ <span class="number">-105</span>,<span class="number">13</span> +<span class="number">203</span>,<span class="number">22</span> @@ <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>,</span><br><span class="line">                input_buffer-&gt;buffer);</span><br><span class="line">         <span class="keyword">continue</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">-    <span class="built_in">execute_statement</span>(&amp;statement);</span><br><span class="line">-    <span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">execute_statement</span>(&amp;statement, table)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (EXECUTE_SUCCESS):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (EXECUTE_TABLE_FULL):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Error: Table full.\n&quot;</span>);</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨:</p>
<p>å¯¹äºswitchä¸­çš„<code>continue &amp; break</code></p>
<p>ç®€å•æ¥è¯´ï¼Œ<code>break</code>åªé€€å‡º<code>switch</code>è¯­å¥æœ¬èº«</p>
<p>å¦‚æœ<code>switch</code>æ˜¯åœ¨å¾ªç¯ä½“ä¸­ï¼Œé‚£ä¹ˆ<code>continue</code>ä¼šè·³è¿‡<strong>æœ¬æ¬¡å¾ªç¯</strong>(å³ä¸æ‰§è¡Œswitchåé¢çš„è¯­å¥).</p>
</blockquote>
<p>åšå®Œè¿™äº›åæˆ‘ä»¬å°±å¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“é‡Œè¾£!</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ ./db</span><br><span class="line">db &gt; insert 1 cstack foo@bar.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; insert 2 bob bob@example.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; select</span><br><span class="line">(1, cstack, foo@bar.com)</span><br><span class="line">(2, bob, bob@example.com)</span><br><span class="line">Executed.</span><br><span class="line">db &gt; insert foo bar 1</span><br><span class="line">Syntax error. Could not parse statement.</span><br><span class="line">db &gt; .exit</span><br><span class="line">~</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ˜¯å†™ä¸€äº›æµ‹è¯•çš„æœ€å¥½æ—¶æœºå–”ï¼Œç†ç”±å¦‚ä¸‹:</p>
<ul>
<li>Weâ€™re planning to dramatically change the data structure storing our table, and tests would catch regressions.</li>
<li>æœ‰ä¸€äº›è¾¹é™…æƒ…å†µæˆ‘ä»¬è¿˜æ²¡æœ‰æ‰‹åŠ¨æµ‹è¯•(e.g. è¡¨è¢«å¡«æ»¡äº†)</li>
</ul>
<p>æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« è§£å†³è¿™äº›é—®é¢˜.è¿™é‡Œæœ‰æœ¬ç« ä»£ç çš„å…¨éƒ¨æ”¹åŠ¨:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@@ <span class="number">-2</span>,<span class="number">6</span> +<span class="number">2</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="type">char</span>* buffer;</span><br><span class="line">@@ <span class="number">-10</span>,<span class="number">6</span> +<span class="number">11</span>,<span class="number">105</span> @@ <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line"> &#125; InputBuffer;</span><br><span class="line"></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; EXECUTE_SUCCESS, EXECUTE_TABLE_FULL &#125; ExecuteResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  META_COMMAND_SUCCESS,</span><br><span class="line">+  META_COMMAND_UNRECOGNIZED_COMMAND</span><br><span class="line">+&#125; MetaCommandResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">+  PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_SYNTAX_ERROR,</span><br><span class="line">+  PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">+ &#125; PrepareResult;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; STATEMENT_INSERT, STATEMENT_SELECT &#125; StatementType;</span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_USERNAME_SIZE 32</span></span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">uint32_t</span> id;</span><br><span class="line">+  <span class="type">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">+  <span class="type">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+&#125; Row;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  StatementType type;</span><br><span class="line">+  Row row_to_insert; <span class="comment">//only used by insert statement</span></span><br><span class="line">+&#125; Statement;</span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> size_of_attribute(Struct, Attribute) sizeof(((Struct*)0)-&gt;Attribute)</span></span><br><span class="line">+</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_SIZE = <span class="built_in">size_of_attribute</span>(Row, id);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_SIZE = <span class="built_in">size_of_attribute</span>(Row, username);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_SIZE = <span class="built_in">size_of_attribute</span>(Row, email);</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ID_OFFSET = <span class="number">0</span>;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> USERNAME_OFFSET = ID_OFFSET + ID_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> EMAIL_OFFSET = USERNAME_OFFSET + USERNAME_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ROW_SIZE = ID_SIZE + USERNAME_SIZE + EMAIL_SIZE;</span><br><span class="line">+</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> TABLE_MAX_PAGES 100</span></span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / ROW_SIZE;</span><br><span class="line">+<span class="type">const</span> <span class="type">uint32_t</span> TABLE_MAX_ROWS = ROWS_PER_PAGE * TABLE_MAX_PAGES;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">uint32_t</span> num_rows;</span><br><span class="line">+  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Table;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">print_row</span><span class="params">(Row* row)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">printf</span>(<span class="string">&quot;(%d, %s, %s)\n&quot;</span>, row-&gt;id, row-&gt;username, row-&gt;email);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, <span class="type">void</span>* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">deserialize_row</span><span class="params">(<span class="type">void</span> *source, Row* destination)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;id), source + ID_OFFSET, ID_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;username), source + USERNAME_OFFSET, USERNAME_SIZE);</span><br><span class="line">+  <span class="built_in">memcpy</span>(&amp;(destination-&gt;email), source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="type">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">+  <span class="type">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">+  <span class="type">void</span> *page = table-&gt;pages[page_num];</span><br><span class="line">+  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+     <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">+     page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="type">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="type">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">+  <span class="keyword">return</span> page + byte_offset;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+  Table* table = (Table*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Table));</span><br><span class="line">+  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+     table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> table;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++) &#123;</span><br><span class="line">+     <span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   InputBuffer* input_buffer = (InputBuffer*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(InputBuffer));</span><br><span class="line">   input_buffer-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">@@ <span class="number">-40</span>,<span class="number">17</span> +<span class="number">140</span>,<span class="number">105</span> @@ <span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table *table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">+    <span class="built_in">free_table</span>(table);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">+  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+    <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+    <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">+	input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">+	statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email</span><br><span class="line">+	);</span><br><span class="line">+    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+	<span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_UNRECOGNIZED_STATEMENT;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_insert</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (table-&gt;num_rows &gt;= TABLE_MAX_ROWS) &#123;</span><br><span class="line">+     <span class="keyword">return</span> EXECUTE_TABLE_FULL;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Row* row_to_insert = &amp;(statement-&gt;row_to_insert);</span><br><span class="line">+</span><br><span class="line">+  <span class="built_in">serialize_row</span>(row_to_insert, <span class="built_in">row_slot</span>(table, table-&gt;num_rows));</span><br><span class="line">+  table-&gt;num_rows += <span class="number">1</span>;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_select</span><span class="params">(Statement* statement, Table* table)</span> </span>&#123;</span><br><span class="line">+  Row row;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; table-&gt;num_rows; i++) &#123;</span><br><span class="line">+     <span class="built_in">deserialize_row</span>(<span class="built_in">row_slot</span>(table, i), &amp;row);</span><br><span class="line">+     <span class="built_in">print_row</span>(&amp;row);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">return</span> EXECUTE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table *table)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">switch</span> (statement-&gt;type) &#123;</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_INSERT):</span><br><span class="line">+       	<span class="keyword">return</span> <span class="built_in">execute_insert</span>(statement, table);</span><br><span class="line">+    <span class="built_in">case</span> (STATEMENT_SELECT):</span><br><span class="line">+	<span class="keyword">return</span> <span class="built_in">execute_select</span>(statement, table);</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">+  Table* table = <span class="built_in">new_table</span>();</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">-    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">-      <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">-      <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">-    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">-      <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;.\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+    <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer, table)) &#123;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_SUCCESS):</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+        <span class="built_in">case</span> (META_COMMAND_UNRECOGNIZED_COMMAND):</span><br><span class="line">+          <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized command &#x27;%s&#x27;\n&quot;</span>, input_buffer-&gt;buffer);</span><br><span class="line">+          <span class="keyword">continue</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    Statement statement;</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_UNRECOGNIZED_STATEMENT):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Unrecognized keyword at start of &#x27;%s&#x27;.\n&quot;</span>,</span><br><span class="line">+               input_buffer-&gt;buffer);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">switch</span> (<span class="built_in">execute_statement</span>(&amp;statement, table)) &#123;</span><br><span class="line">+	<span class="built_in">case</span> (EXECUTE_SUCCESS):</span><br><span class="line">+	    <span class="built_in">printf</span>(<span class="string">&quot;Executed.\n&quot;</span>);</span><br><span class="line">+	    <span class="keyword">break</span>;</span><br><span class="line">+	<span class="built_in">case</span> (EXECUTE_TABLE_FULL):</span><br><span class="line">+	    <span class="built_in">printf</span>(<span class="string">&quot;Error: Table full.\n&quot;</span>);</span><br><span class="line">+	    <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Part-4-Our-First-Tests-and-Bugs"><a href="#Part-4-Our-First-Tests-and-Bugs" class="headerlink" title="Part 4 - Our First Tests (and Bugs)"></a>Part 4 - Our First Tests (and Bugs)</h2><p>æˆ‘ä»¬å·²ç»å¯ä»¥å‘æ•°æ®åº“ä¸­æ’å…¥è¡Œç„¶åæ‰“å°æ‰€æœ‰è¡Œäº†.è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ç›®å‰å®ç°çš„åŠŸèƒ½.</p>
<p>æˆ‘å°†ä¼šä½¿ç”¨<a target="_blank" rel="noopener" href="http://rspec.info/">rspec</a>æ¥æµ‹è¯•å› ä¸ºæˆ‘æ¯”è¾ƒç†Ÿæ‚‰å®ƒ,å¹¶ä¸”å®ƒçš„è¯­æ³•ç›¸å½“å‹å¥½.</p>
<p>æˆ‘å°†å®šä¹‰ä¸€ä¸ªè¾…åŠ©å·¥å…·æ¥ç»™æ•°æ®åº“å‘é€å‘½ä»¤ç„¶åæ–­è¨€è¾“å‡º:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">describe &#x27;database&#x27; do</span><br><span class="line">  def run_script(commands)</span><br><span class="line">    raw_output = nil</span><br><span class="line">    IO.popen(&quot;./db&quot;, &quot;r+&quot;) do |pipe|</span><br><span class="line">      commands.each do |command|</span><br><span class="line">        pipe.puts command</span><br><span class="line">      end</span><br><span class="line"></span><br><span class="line">      pipe.close_write</span><br><span class="line"></span><br><span class="line">      # Read entire output</span><br><span class="line">      raw_output = pipe.gets(nil)</span><br><span class="line">    end</span><br><span class="line">    raw_output.split(&quot;\n&quot;)</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  it &#x27;inserts and retrieves a row&#x27; do</span><br><span class="line">    result = run_script([</span><br><span class="line">      &quot;insert 1 user1 person1@example.com&quot;,</span><br><span class="line">      &quot;select&quot;,</span><br><span class="line">      &quot;.exit&quot;,</span><br><span class="line">    ])</span><br><span class="line">    expect(result).to match_array([</span><br><span class="line">      &quot;db &gt; Executed.&quot;,</span><br><span class="line">      &quot;db &gt; (1, user1, person1@example.com)&quot;,</span><br><span class="line">      &quot;Executed.&quot;,</span><br><span class="line">      &quot;db &gt; &quot;,</span><br><span class="line">    ])</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç»“æœ:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rspec test.rb</span><br><span class="line"></span><br><span class="line">Finished in 0.00871 seconds (files took 0.09506 seconds to load)</span><br><span class="line">1 example, 0 failures</span><br></pre></td></tr></table></figure>

<p>æ˜¯æ—¶å€™æµ‹è¯•æ’å…¥å¤§é‡è¡Œäº†:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">it &#x27;prints error message when table is full&#x27; do</span><br><span class="line">  script = (1..1401).map do |i|</span><br><span class="line">    &quot;insert #&#123;i&#125; user#&#123;i&#125; person#&#123;i&#125;@example.com&quot;</span><br><span class="line">  end</span><br><span class="line">  script &lt;&lt; &quot;.exit&quot;</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result[-2]).to eq(&#x27;db &gt; Error: Table full.&#x27;)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>é‡æ–°æµ‹è¯•â€¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Finished in 0.01553 seconds (files took 0.08156 seconds to load)</span><br><span class="line">2 examples, 0 failures</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•æˆåŠŸ!æ•°æ®åº“ç›®å‰å¯ä»¥ä¿å­˜1400è¡Œå› ä¸ºæˆ‘ä»¬è®¾ç½®äº†æœ€å¤§é¡µæ•°ä¸º100,æ¯é¡µå¯ä»¥å­˜å‚¨14è¡Œ.</p>
<p>æ£€æŸ¥ä¸€ä¸‹ç›®å‰çš„ä»£ç ,å¯ä»¥å‘ç°æˆ‘ä»¬æ²¡æœ‰ä»”ç»†å¤„ç†æ–‡æœ¬å­—æ®µ,ç”¨è¿™ä¸ªä¾‹å­æµ‹è¯•:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">it &#x27;allows inserting strings that are the maximum length&#x27; do</span><br><span class="line">  long_username = &quot;a&quot;*32</span><br><span class="line">  long_email = &quot;a&quot;*255</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; (1, #&#123;long_username&#125;, #&#123;long_email&#125;)&quot;,</span><br><span class="line">    &quot;Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>Faliures:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1) database allows inserting strings that are the maximum length</span><br><span class="line">   Failure/Error: raw_output.split(&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">   ArgumentError:</span><br><span class="line">     invalid byte sequence in UTF-8</span><br><span class="line">   # ./spec/main_spec.rb:14:in `split&#x27;</span><br><span class="line">   # ./spec/main_spec.rb:14:in `run_script&#x27;</span><br><span class="line">   # ./spec/main_spec.rb:48:in `block (2 levels) in &lt;top (required)&gt;&#x27;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨æµ‹è¯•ï¼Œæ‰“å°å‡ºæ¥çš„ç»“æœä¼šæœ‰ä¸€äº›å¥‡æ€ªçš„å­—ç¬¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db &gt; insert 1 aaaaa... aaaaa...</span><br><span class="line">Executed.</span><br><span class="line">db &gt; select</span><br><span class="line">(1, aaaaa...aaa\, aaaaa...aaa\)</span><br><span class="line">Executed.</span><br><span class="line">db &gt;</span><br></pre></td></tr></table></figure>

<p>å‘ç”Ÿäº†ä»€ä¹ˆ?å¦‚æœæŸ¥çœ‹Rowçš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ç»™usernameåˆ†é…äº†32å­—èŠ‚ï¼Œemail 255å­—èŠ‚.ä½†æ˜¯<a target="_blank" rel="noopener" href="http://www.cprogramming.com/tutorial/c/lesson9.html">C strings</a>åº”è¯¥ä»¥nullå­—ç¬¦(<code>&#39;\0&#39;</code>)ç»“å°¾,è€Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç»™è¿™ä¸€ä½åˆ†é…ç©ºé—´.è§£å†³åŠæ³•æ˜¯é¢å¤–åˆ†é…ä¸€ä¸ªå­—èŠ‚:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="type">const</span> <span class="type">uint32_t</span> COLUMN_EMAIL_SIZE = <span class="number">255</span>;</span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="type">uint32_t</span> id;</span><br><span class="line">-  <span class="type">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">-  <span class="type">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+  <span class="type">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">+  <span class="type">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line"> &#125; Row;</span><br></pre></td></tr></table></figure>

<p>ç„¶åé—®é¢˜è¢«ä¿®å¤äº†:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Finished in 0.0188 seconds (files took 0.08516 seconds to load)</span><br><span class="line">3 examples, 0 failures</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸åº”è¯¥å…è®¸æ’å…¥çš„usernameæˆ–emailè¶…è¿‡æœ€å¤§é•¿åº¦,è¿™ç§æƒ…å†µä¸‹ç»“æœåº”è¯¥åƒè¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">it &#x27;prints error message if strings are too long&#x27; do</span><br><span class="line">  long_username = &quot;a&quot;*33</span><br><span class="line">  long_email = &quot;a&quot;*256</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; String is too long.&quot;,</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†å®ç°è¿™ä¸ªæˆ‘ä»¬éœ€è¦ä¿®æ”¹è§£æå™¨.æé†’ä¸€ä¸‹ï¼Œæˆ‘ä»¬è§£æè¾“å…¥ç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="https://linux.die.net/man/3/scanf">scanf()</a>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">  statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">  <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">      input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">      statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line"><span class="comment">//sscanfåªæ˜¯å°†è¾“å…¥ä»stdinå˜æˆstring</span></span><br><span class="line">  <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2430303/disadvantages-of-scanf">scanfæœ‰ä¸€äº›ç¼ºç‚¹</a>.å¦‚æœè¯»å–çš„é•¿åº¦å¤§äºç›®æ ‡ç¼“å†²åŒºçš„é•¿åº¦ï¼Œä¼šé€ æˆç¼“å†²åŒºç§»é™¤å¹¶å°†å¤šä½™çš„æ•°æ®å†™å…¥é¢„æœŸä¹‹å¤–çš„åœ°æ–¹.æˆ‘ä»¬å¸Œæœ›åœ¨å°†æ•°æ®copyåˆ°Rowç»“æ„ä½“å†…ä¹‹å‰å…ˆæ£€æŸ¥æ¯ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦.ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ç©ºæ ¼å°†è¾“å…¥åˆ†å‰²æˆå‡ ä¸ªéƒ¨åˆ†.</p>
<blockquote>
<p>è¯‘è€…æ³¨: äº‹å®ä¸Šï¼Œä¸å®Œå…¨æ­£ç¡®.</p>
<p>å¯ä»¥ç”¨æ ¼å¼å­—ç¬¦ä¸²é™åˆ¶é•¿åº¦    scanf(â€œ%<code>wid</code>sâ€,s1)</p>
<p>ä¾‹å¦‚é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦ä¸º100    <code>scanf(&quot;%100s&quot;,s1)</code></p>
<p>é‡åˆ°<code>blank</code>æˆ–è€…è¯»å–100ä¸ªå­—ç¬¦å°±ä¼šç»“æŸ.ä¸è¿‡éœ€è¦è‡ªå·±ç¡®ä¿s1æœ‰é¢å¤–ç©ºé—´ä¿å­˜<code>\0</code>å­—ç¬¦</p>
<p><code>blank</code>: æŒ‡ ç©ºæ ¼(space),åˆ¶è¡¨ç¬¦(Tab),å›è½¦ç¬¦(â€˜\nâ€™).</p>
<p>scanfè¿˜æœ‰å¾ˆå¤šç‰¹æ€§ï¼Œæ¯”å¦‚ä¼šå¿½ç•¥å¼€å¤´çš„æ‰€æœ‰ç©ºç™½ç¬¦ï¼Œ%cè¿”å›é”®ç›˜ç¼“å†²åŒºçš„ç¬¬ä¸€ä¸ªå­—ç¬¦(åŒ…æ‹¬å›è½¦)â€¦</p>
<p>æ„Ÿå…´è¶£<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/io/c/fscanf">è‡ªè¡ŒæŸ¥é˜…</a></p>
</blockquote>
<p>ä½¿ç”¨<a target="_blank" rel="noopener" href="http://www.cplusplus.com/reference/cstring/strtok/">strtok()</a>æ¥å®ç°è¿™ä¸ªåŠŸèƒ½:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">+  statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">char</span>* keyword = <span class="built_in">strtok</span>(input_buffer-&gt;buffer, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* id_string = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* username = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* email = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">int</span> id = <span class="built_in">atoi</span>(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  statement-&gt;row_to_insert.id = id;</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 Statement* statement)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> <span class="built_in">prepare_insert</span>(input_buffer, statement);</span><br><span class="line">-    statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">-    <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">-        input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">-        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);</span><br><span class="line">-    <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">-      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">-    &#125;</span><br><span class="line">-    <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>strtok</code>åœ¨é‡åˆ°åˆ†å‰²å­—ç¬¦(æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ç©ºæ ¼)æ—¶å°±æ’å…¥NULLå­—ç¬¦ï¼Œä»è€Œå°†è¾“å…¥ç¼“å†²åˆ†å‰²æˆäº†å­å­—ç¬¦ä¸².è¿”å›å€¼ä¸ºæŒ‡å‘å­ä¸²å¼€å¤´çš„æŒ‡é’ˆ.</p>
<blockquote>
<p>æ³¨: ç®€è¦è¯´æ˜ä¸€ä¸‹<code>strtok</code>çš„åŸç†.</p>
<p><code>strtok</code>ç»´æŠ¤ä¸€ä¸ªé™æ€å±€éƒ¨æŒ‡é’ˆå˜é‡<code>next</code>ï¼Œéåˆ†å‰²å­—ç¬¦ä¸åˆ†å‰²å­—ç¬¦ä¹‹é—´çš„å­ä¸²å«åš<code>token</code>ï¼Œå¦‚æœ<code>strtok</code>åœ¨è¾“å…¥æµä¸­æ‰¾åˆ°<code>token</code>ï¼Œè¿”å›æŒ‡å‘<code>token</code>å¼€å¤´çš„æŒ‡é’ˆï¼Œç„¶å<code>next</code>æŒ‡å‘<code>token</code>ä¹‹åçš„åˆ†å‰²å­—ç¬¦çš„åä¸€ä¸ªå­—èŠ‚.</p>
<p>å¦‚æœ<code>strtok(const char* str,const char* delimiter)</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>str</code>ä¸ºNULL,é‚£ä¹ˆç›¸å½“äºæŠŠ<code>next</code>èµ‹å€¼ç»™<code>str</code>(å³ä»ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„tokenä¹‹åå¼€å§‹)</p>
</blockquote>
<p>ç„¶åç”¨<a target="_blank" rel="noopener" href="http://www.cplusplus.com/reference/cstring/strlen/">strlen()</a>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦è¶…å‡ºé•¿åº¦é™åˆ¶.</p>
<p>æˆ‘ä»¬å¯ä»¥åƒå¤„ç†å…¶å®ƒé”™è¯¯ç ä¸€æ ·å¤„ç†<code>PREPARE_STRING_TOO_LONG</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">enum</span> <span class="title class_">PrepareResult_t</span> &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">   <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">+  <span class="built_in">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;String is too long.\n&quot;</span>);</span><br><span class="line">+    <span class="keyword">continue</span>;</span><br><span class="line">   <span class="built_in">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line">     <span class="keyword">continue</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åšå®Œè¿™äº›å°±å¯ä»¥é€šè¿‡æµ‹è¯•è¾£~</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Finished in 0.02284 seconds (files took 0.116 seconds to load)</span><br><span class="line">4 examples, 0 failures</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œåˆ°ç°åœ¨ï¼Œæˆ‘ä»¬ä¸å¦¨å¤„ç†æ›´å¤šé”™è¯¯æƒ…å†µ:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">it &#x27;prints an error message if id is negative&#x27; do</span><br><span class="line">  script = [</span><br><span class="line">    &quot;insert -1 cstack foo@bar.com&quot;,</span><br><span class="line">    &quot;select&quot;,</span><br><span class="line">    &quot;.exit&quot;,</span><br><span class="line">  ]</span><br><span class="line">  result = run_script(script)</span><br><span class="line">  expect(result).to match_array([</span><br><span class="line">    &quot;db &gt; ID must be positive.&quot;,</span><br><span class="line">    &quot;db &gt; Executed.&quot;,</span><br><span class="line">    &quot;db &gt; &quot;,</span><br><span class="line">  ])</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">enum</span> <span class="title class_">PrepareResult_t</span> &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_NEGATIVE_ID,</span><br><span class="line">   PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">@@ <span class="number">-148</span>,<span class="number">9</span> +<span class="number">147</span>,<span class="number">6</span> @@ <span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">int</span> id = <span class="built_in">atoi</span>(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="keyword">return</span> PREPARE_NEGATIVE_ID;</span><br><span class="line">+  &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">   &#125;</span><br><span class="line">@@ <span class="number">-230</span>,<span class="number">9</span> +<span class="number">226</span>,<span class="number">6</span> @@ <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_NEGATIVE_ID):</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;ID must be positive.\n&quot;</span>);</span><br><span class="line">+        <span class="keyword">continue</span>;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;String is too long.\n&quot;</span>);</span><br><span class="line">         <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œç›®å‰æ¥è¯´æµ‹è¯•å·²ç»è¶³å¤Ÿäº†.ä¸‹ä¸€ç« æ˜¯éå¸¸é‡è¦çš„åŠŸèƒ½:ä¿å­˜!æˆ‘ä»¬å°†ä¼šæŠŠæ•°æ®åº“ä¿å­˜åˆ°æ–‡ä»¶ä¸­ç„¶åè¯»å–åˆ°å†…å­˜ä¸­.</p>
<p>è¿™ä¼šå¾ˆæ£’çš„.</p>
<p>è¿™é‡Œæ˜¯è¿™ç« èŠ‚ä»£ç çš„å…¨éƒ¨æ”¹åŠ¨:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@@ <span class="number">-22</span>,<span class="number">6</span> +<span class="number">22</span>,<span class="number">8</span> @@</span><br><span class="line"></span><br><span class="line"> <span class="keyword">enum</span> <span class="title class_">PrepareResult_t</span> &#123;</span><br><span class="line">   PREPARE_SUCCESS,</span><br><span class="line">+  PREPARE_NEGATIVE_ID,</span><br><span class="line">+  PREPARE_STRING_TOO_LONG,</span><br><span class="line">   PREPARE_SYNTAX_ERROR,</span><br><span class="line">   PREPARE_UNRECOGNIZED_STATEMENT</span><br><span class="line">  &#125;;</span><br><span class="line">@@ <span class="number">-34</span>,<span class="number">8</span> +<span class="number">36</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="keyword">define</span> COLUMN_EMAIL_SIZE 255</span></span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="type">uint32_t</span> id;</span><br><span class="line">-  <span class="type">char</span> username[COLUMN_USERNAME_SIZE];</span><br><span class="line">-  <span class="type">char</span> email[COLUMN_EMAIL_SIZE];</span><br><span class="line">+  <span class="type">char</span> username[COLUMN_USERNAME_SIZE + <span class="number">1</span>];</span><br><span class="line">+  <span class="type">char</span> email[COLUMN_EMAIL_SIZE + <span class="number">1</span>];</span><br><span class="line"> &#125; Row;</span><br><span class="line"></span><br><span class="line">@@ <span class="number">-150</span>,<span class="number">18</span> +<span class="number">152</span>,<span class="number">40</span> @@ <span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table *table)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">-<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">-                                Statement* statement)</span> </span>&#123;</span><br><span class="line">-  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">   statement-&gt;type = STATEMENT_INSERT;</span><br><span class="line">-  <span class="type">int</span> args_assigned = <span class="built_in">sscanf</span>(</span><br><span class="line">-     input_buffer-&gt;buffer, <span class="string">&quot;insert %d %s %s&quot;</span>, &amp;(statement-&gt;row_to_insert.id),</span><br><span class="line">-     statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email</span><br><span class="line">-     );</span><br><span class="line">-  <span class="keyword">if</span> (args_assigned &lt; <span class="number">3</span>) &#123;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">char</span>* keyword = <span class="built_in">strtok</span>(input_buffer-&gt;buffer, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* id_string = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* username = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+  <span class="type">char</span>* email = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (id_string == <span class="literal">NULL</span> || username == <span class="literal">NULL</span> || email == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> PREPARE_SYNTAX_ERROR;</span><br><span class="line">   &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">int</span> id = <span class="built_in">atoi</span>(id_string);</span><br><span class="line">+  <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_NEGATIVE_ID;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(username) &gt; COLUMN_USERNAME_SIZE) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strlen</span>(email) &gt; COLUMN_EMAIL_SIZE) &#123;</span><br><span class="line">+     <span class="keyword">return</span> PREPARE_STRING_TOO_LONG;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  statement-&gt;row_to_insert.id = id;</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.username, username);</span><br><span class="line">+  <span class="built_in">strcpy</span>(statement-&gt;row_to_insert.email, email);</span><br><span class="line">+</span><br><span class="line">   <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line">+</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">+                                Statement* statement)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+      <span class="keyword">return</span> <span class="built_in">prepare_insert</span>(input_buffer, statement);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;select&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     statement-&gt;type = STATEMENT_SELECT;</span><br><span class="line">@@ <span class="number">-223</span>,<span class="number">6</span> +<span class="number">247</span>,<span class="number">12</span> @@ <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">     <span class="keyword">switch</span> (<span class="built_in">prepare_statement</span>(input_buffer, &amp;statement)) &#123;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_SUCCESS):</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_NEGATIVE_ID):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">&quot;ID must be positive.\n&quot;</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">+      <span class="built_in">case</span> (PREPARE_STRING_TOO_LONG):</span><br><span class="line">+	<span class="built_in">printf</span>(<span class="string">&quot;String is too long.\n&quot;</span>);</span><br><span class="line">+	<span class="keyword">continue</span>;</span><br><span class="line">       <span class="built_in">case</span> (PREPARE_SYNTAX_ERROR):</span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">&quot;Syntax error. Could not parse statement.\n&quot;</span>);</span><br><span class="line"> 	<span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™æ˜¯æµ‹è¯•:</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">+describe <span class="symbol">&#x27;database</span>&#x27; <span class="keyword">do</span></span><br><span class="line">+  def <span class="title function_ invoke__">run_script</span>(commands)</span><br><span class="line">+    raw_output = nil</span><br><span class="line">+    IO.<span class="title function_ invoke__">popen</span>(<span class="string">&quot;./db&quot;</span>, <span class="string">&quot;r+&quot;</span>) <span class="keyword">do</span> |pipe|</span><br><span class="line">+      commands.each <span class="keyword">do</span> |command|</span><br><span class="line">+        pipe.puts command</span><br><span class="line">+      end</span><br><span class="line">+</span><br><span class="line">+      pipe.close_write</span><br><span class="line">+</span><br><span class="line">+      # Read entire output</span><br><span class="line">+      raw_output = pipe.<span class="title function_ invoke__">gets</span>(nil)</span><br><span class="line">+    end</span><br><span class="line">+    raw_output.<span class="title function_ invoke__">split</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it <span class="symbol">&#x27;inserts</span> and retrieves a row&#x27; <span class="keyword">do</span></span><br><span class="line">+    result = <span class="title function_ invoke__">run_script</span>([</span><br><span class="line">+      <span class="string">&quot;insert 1 user1 person1@example.com&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;select&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; (1, user1, person1@example.com)&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it <span class="symbol">&#x27;prints</span> error message when table is full&#x27; <span class="keyword">do</span></span><br><span class="line">+    script = (<span class="number">1</span>..<span class="number">1401</span>).map <span class="keyword">do</span> |i|</span><br><span class="line">+      <span class="string">&quot;insert #&#123;i&#125; user#&#123;i&#125; person#&#123;i&#125;@example.com&quot;</span></span><br><span class="line">+    end</span><br><span class="line">+    script &lt;&lt; <span class="string">&quot;.exit&quot;</span></span><br><span class="line">+    result = <span class="title function_ invoke__">run_script</span>(script)</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result[-<span class="number">2</span>]).to <span class="title function_ invoke__">eq</span>(<span class="symbol">&#x27;db</span> &gt; Error: Table full.&#x27;)</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it <span class="symbol">&#x27;allows</span> inserting strings that are the maximum length&#x27; <span class="keyword">do</span></span><br><span class="line">+    long_username = <span class="string">&quot;a&quot;</span>*<span class="number">32</span></span><br><span class="line">+    long_email = <span class="string">&quot;a&quot;</span>*<span class="number">255</span></span><br><span class="line">+    script = [</span><br><span class="line">+      <span class="string">&quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;select&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ]</span><br><span class="line">+    result = <span class="title function_ invoke__">run_script</span>(script)</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; (1, #&#123;long_username&#125;, #&#123;long_email&#125;)&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it <span class="symbol">&#x27;prints</span> error message <span class="keyword">if</span> strings are too long&#x27; <span class="keyword">do</span></span><br><span class="line">+    long_username = <span class="string">&quot;a&quot;</span>*<span class="number">33</span></span><br><span class="line">+    long_email = <span class="string">&quot;a&quot;</span>*<span class="number">256</span></span><br><span class="line">+    script = [</span><br><span class="line">+      <span class="string">&quot;insert 1 #&#123;long_username&#125; #&#123;long_email&#125;&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;select&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ]</span><br><span class="line">+    result = <span class="title function_ invoke__">run_script</span>(script)</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; String is too long.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">+  it <span class="symbol">&#x27;prints</span> an error message <span class="keyword">if</span> id is negative&#x27; <span class="keyword">do</span></span><br><span class="line">+    script = [</span><br><span class="line">+      <span class="string">&quot;insert -1 cstack foo@bar.com&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;select&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ]</span><br><span class="line">+    result = <span class="title function_ invoke__">run_script</span>(script)</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; ID must be positive.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+end</span><br></pre></td></tr></table></figure>



<h2 id="Part-5-Persistence-to-Disk"><a href="#Part-5-Persistence-to-Disk" class="headerlink" title="Part 5 - Persistence to Disk"></a>Part 5 - Persistence to Disk</h2><p>ç›®å‰æ•°æ®åº“å…è®¸æ’å…¥è®°å½•å¹¶ä¸”è¯»å–ï¼Œä½†ä»…é™ç¨‹åºè¿è¡ŒæœŸé—´.å¦‚æœå…³é—­ç¨‹åºç„¶åé‡æ–°æ‰“å¼€ï¼Œæ‰€æœ‰çš„è®°å½•éƒ½æ¶ˆå¤±äº†.æˆ‘ä»¬æœŸæœ›çš„æ•°æ®åº“è¡¨ç°åº”è¯¥æ˜¯è¿™æ ·:</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">it <span class="symbol">&#x27;keeps</span> data after closing connection&#x27; <span class="keyword">do</span></span><br><span class="line">  result1 = <span class="title function_ invoke__">run_script</span>([</span><br><span class="line">    <span class="string">&quot;insert 1 user1 person1@example.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">  ])</span><br><span class="line">  <span class="title function_ invoke__">expect</span>(result1).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">    <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">  ])</span><br><span class="line">  result2 = <span class="title function_ invoke__">run_script</span>([</span><br><span class="line">    <span class="string">&quot;select&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">  ])</span><br><span class="line">  <span class="title function_ invoke__">expect</span>(result2).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">    <span class="string">&quot;db &gt; (1, user1, person1@example.com)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Executed.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">  ])</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å’Œsqliteä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡å°†æ•´ä¸ªæ•°æ®åº“ä¿å­˜åˆ°æ–‡ä»¶ä¸­æ¥æ°¸ä¹…å­˜å‚¨è®°å½•.</p>
<p>æˆ‘ä»¬ç›®å‰å·²ç»å¯ä»¥å°†è¡Œåºåˆ—åŒ–å­˜å‚¨è¿›é¡µå°ºå¯¸çš„å†…å­˜å—.ä¸ºäº†å®ç°æ°¸ä¹…å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŠŠå†…å­˜å—å†™å…¥æ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡è¿è¡Œç¨‹åºæ—¶æŠŠæ•°æ®è¯»å–åˆ°å†…å­˜ä¸­.</p>
<p>ä¸ºäº†è®©äº‹æƒ…æ›´ç®€å•ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå«åš<code>pager</code>çš„æŠ½è±¡å±‚.æˆ‘ä»¬å‘pageræŸ¥è¯¢page X,ç„¶åpagerè¿”å›ä¸€ä¸ªå†…å­˜å—,pageré¦–å…ˆåœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰è¿™ä¸€é¡µï¼Œå°±å°†æ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…å­˜(é€šè¿‡è¯»å–æ•°æ®åº“æ–‡ä»¶).</p>
<p>SQLiteæ¶æ„å…·ä½“åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ç¨‹åº</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/arch-part5.gif" alt="img"></p>
<p>Pagerè´Ÿè´£pageç¼“å­˜å’Œæ•°æ®åº“æ–‡ä»¶,Tableå¯¹è±¡é€šè¿‡pagerè¯·æ±‚pages:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">int</span> file_descriptor;</span><br><span class="line">+  <span class="type">uint32_t</span> file_length;</span><br><span class="line">+  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Pager;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">-  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+  Pager* pager;</span><br><span class="line">   <span class="type">uint32_t</span> num_rows;</span><br><span class="line"> &#125; Table;</span><br></pre></td></tr></table></figure>

<p>æˆ‘å°†<code>new_table()</code>å‡½æ•°é‡å‘½åä¸º<code>db_open()</code>å› ä¸ºå®ƒç°åœ¨è´Ÿè´£æ‰“å¼€æ•°æ®åº“ï¼Œå¼€æ•°æ®åº“ï¼Œæ„å‘³ç€:</p>
<ul>
<li>æ‰“å¼€æ•°æ®åº“æ–‡ä»¶</li>
<li>åˆå§‹åŒ–pager</li>
<li>åˆå§‹åŒ–table</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">-<span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+<span class="function">Table* <span class="title">db_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename)</span> </span>&#123;</span><br><span class="line">+  Pager* pager = <span class="built_in">pager_open</span>(filename);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¯‘è€…æ³¨: åŸæ–‡ä¸º uint32_t num_rows = pager-&gt;file_length / ROW_SIZE;</span></span><br><span class="line"><span class="comment">ä½†è¿™é‡Œéœ€è¦è€ƒè™‘pageçš„å¤§å°ä¸ä¸ºrowçš„æ•´æ•°å€çš„æƒ…å†µ,æ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ æ–‡ä»¶å¤§å°/è¡Œå¤§å° æ¥æ±‚è¡Œæ•°,</span></span><br><span class="line"><span class="comment">å› ä¸ºæ¯é¡µä¸­å¯èƒ½è¿˜æœ‰ä¸€äº›ç©ºé—´æ˜¯æ— æ•ˆçš„(pageåªèƒ½æ”¾æ•´æ•°ä¸ªrow)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+  <span class="type">uint32_t</span> num_rows=pager-&gt;file_length/PAGE_SIZE*ROWS_PER_PAGE;   <span class="comment">//æ•´é¡µçš„æ‰€æœ‰è¡Œ</span></span><br><span class="line"></span><br><span class="line">+  <span class="type">uint32_t</span> extra_bytes=pager-&gt;file_length%PAGE_SIZE;</span><br><span class="line">+  <span class="keyword">if</span> (extra_bytes&gt;<span class="number">0</span>)&#123;    <span class="comment">//æ®‹ç¼ºé¡µçš„é¢å¤–è¡Œ</span></span><br><span class="line">+    <span class="type">uint32_t</span> addtional_rows=extra_bytes/ROW_SIZE;</span><br><span class="line">+    num_rows+=addtional_rows;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">   Table* table = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Table));</span><br><span class="line">-  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+  table-&gt;pager = pager;</span><br><span class="line">+  table-&gt;num_rows = num_rows;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> table;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>db_open()</code>å‡½æ•°è°ƒç”¨äº†<code>pager_open()</code>ï¼Œ<code>pager_open</code>æ‰“å¼€ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶å¹¶è¿½è¸ªæ•°æ®åº“å¤§å°.å®ƒè¿˜ä¼šå°†pageç¼“å­˜åˆå§‹åŒ–ä¸ºNULL.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function">Pager* <span class="title">pager_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename)</span> </span>&#123;</span><br><span class="line">+  <span class="type">int</span> fd = <span class="built_in">open</span>(filename,</span><br><span class="line">+                O_RDWR |      <span class="comment">// Read/Write mode</span></span><br><span class="line">+                    O_CREAT,  <span class="comment">// Create file if it does not exist</span></span><br><span class="line">+                S_IWUSR |     <span class="comment">// User write permission</span></span><br><span class="line">+                    S_IRUSR   <span class="comment">// User read permission</span></span><br><span class="line">+                );</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Unable to open file\n&quot;</span>);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">off_t</span> file_length = <span class="built_in">lseek</span>(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">+</span><br><span class="line">+  Pager* pager = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Pager));</span><br><span class="line">+  pager-&gt;file_descriptor = fd;</span><br><span class="line">+  pager-&gt;file_length = file_length;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+    pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> pager;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæœ‰äº†æ–°çš„pagerå±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè·å–pageçš„é€»è¾‘æ”¾å…¥pagerè‡ªå·±çš„æ–¹æ³•ä¸­:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="type">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="type">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">   <span class="type">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">-  <span class="type">void</span>* page = table-&gt;pages[page_num];</span><br><span class="line">-  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">-    <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">-    page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">-  &#125;</span><br><span class="line">+  <span class="type">void</span>* page = <span class="built_in">get_page</span>(table-&gt;pager, page_num);</span><br><span class="line">   <span class="type">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">   <span class="type">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">   <span class="keyword">return</span> page + byte_offset;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>get_page()</code>å‡½æ•°åŒ…å«å¤„ç†ç¼“å­˜æœªå‘½ä¸­çš„é€»è¾‘.æˆ‘ä»¬å‡è®¾pagesæ˜¯ä¸€ä¸ªæ¥ç€ä¸€ä¸ªçš„ä¿å­˜åœ¨æ•°æ®åº“æ–‡ä»¶ä¸­çš„: Page 0 çš„åç§»ä¸º0ï¼ŒPage 1 çš„åç§»ä¸º4096(pageå¤§å°ä¸º4096),page 2 çš„åç§»ä¸º8192,etc.å¦‚æœè¢«è¯·æ±‚çš„pageè¶…å‡ºäº†æ–‡ä»¶çš„è¾¹ç•Œï¼Œæˆ‘ä»¬çŸ¥é“å®ƒåº”è¯¥æ˜¯ç©ºç™½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åˆ†é…ä¸€äº›å†…å­˜ç©ºé—´ç„¶åè¿”å›å®ƒ.ç¨åæˆ‘ä»¬å°†ç¼“å­˜å†™å…¥ç£ç›˜æ—¶pageä¼šè¢«è¿½åŠ åˆ°æ–‡ä»¶ä¸­.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function"><span class="type">void</span>* <span class="title">get_page</span><span class="params">(Pager* pager, <span class="type">uint32_t</span> page_num)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (page_num &gt;= TABLE_MAX_PAGES) &#123;</span><br><span class="line">    <span class="comment">//è¯‘è€…æ³¨: åŸæ–‡ä¸º page_num &gt; TABLE_MAX_PAGES,ä½†page_numä¸ºä¸‹æ ‡ï¼Œå› æ­¤è¾¹ç•Œæ¡ä»¶ä¸ºTABLE_MAX_PAGES-1</span></span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Tried to fetch page number out of bounds. %d &gt; %d\n&quot;</span>, page_num,</span><br><span class="line">+           TABLE_MAX_PAGES);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="comment">// Cache miss. Allocate memory and load from file.</span></span><br><span class="line">+    <span class="type">void</span>* page = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+    <span class="type">uint32_t</span> num_pages = pager-&gt;file_length / PAGE_SIZE;</span><br><span class="line">+</span><br><span class="line">+    <span class="comment">// We might save a partial page at the end of the file</span></span><br><span class="line">+    <span class="keyword">if</span> (pager-&gt;file_length % PAGE_SIZE) &#123;</span><br><span class="line">+      num_pages += <span class="number">1</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (page_num &lt;= num_pages<span class="number">-1</span>) &#123;</span><br><span class="line">     <span class="comment">//è¯‘è€…æ³¨: åŸæ–‡ä¸º page_num&lt;=num_pages	åŒæ ·ï¼Œå› ä¸ºpage_numä¸ºä¸‹æ ‡è€Œnum_pagesä¸ºé¡µæ•°ï¼Œæ‰€ä»¥è¾¹ç•Œä¸ºnum_pages-1</span></span><br><span class="line">+      <span class="built_in">lseek</span>(pager-&gt;file_descriptor, page_num * PAGE_SIZE, SEEK_SET);</span><br><span class="line">+      <span class="type">ssize_t</span> bytes_read = <span class="built_in">read</span>(pager-&gt;file_descriptor, page, PAGE_SIZE);</span><br><span class="line">+      <span class="keyword">if</span> (bytes_read == <span class="number">-1</span>) &#123;</span><br><span class="line">+        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file: %d\n&quot;</span>, errno);</span><br><span class="line">+        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+      &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    pager-&gt;pages[page_num] = page;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> pager-&gt;pages[page_num];</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>ç›®å‰æ¥è¯´ï¼Œç­‰åˆ°ç”¨æˆ·å…³é—­æ•°æ®åº“è¿æ¥åï¼Œæˆ‘ä»¬æ‰æŠŠç¼“å­˜å†™å…¥ç£ç›˜.å½“ç”¨æˆ·é€€å‡ºæ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–°çš„å‡½æ•°<code>db_close</code>,å®ƒå°†</p>
<ul>
<li>å°†é¡µç¼“å­˜å†™å…¥ç£ç›˜</li>
<li>å…³é—­æ•°æ®åº“æ–‡ä»¶</li>
<li>é‡Šæ”¾Pagerå’ŒTableçš„å†…å­˜</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function"><span class="type">void</span> <span class="title">db_close</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+  Pager* pager = table-&gt;pager;</span><br><span class="line">+  <span class="type">uint32_t</span> num_full_pages = table-&gt;num_rows / ROWS_PER_PAGE;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; num_full_pages; i++) &#123;</span><br><span class="line">+    <span class="keyword">if</span> (pager-&gt;pages[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+      <span class="keyword">continue</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+    <span class="built_in">pager_flush</span>(pager, i, PAGE_SIZE);</span><br><span class="line">+    <span class="built_in">free</span>(pager-&gt;pages[i]);</span><br><span class="line">+    pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="comment">// There may be a partial page to write to the end of the file</span></span><br><span class="line">+  <span class="comment">// This should not be needed after we switch to a B-tree</span></span><br><span class="line">+  <span class="type">uint32_t</span> num_additional_rows = table-&gt;num_rows % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">if</span> (num_additional_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="type">uint32_t</span> page_num = num_full_pages;</span><br><span class="line">+    <span class="keyword">if</span> (pager-&gt;pages[page_num] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">+      <span class="built_in">pager_flush</span>(pager, page_num, num_additional_rows * ROW_SIZE);</span><br><span class="line">+      <span class="built_in">free</span>(pager-&gt;pages[page_num]);</span><br><span class="line">+      pager-&gt;pages[page_num] = <span class="literal">NULL</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">int</span> result = <span class="built_in">close</span>(pager-&gt;file_descriptor);</span><br><span class="line">+  <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Error closing db file.\n&quot;</span>);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+    <span class="type">void</span>* page = pager-&gt;pages[i];</span><br><span class="line">+    <span class="keyword">if</span> (page) &#123;</span><br><span class="line">+      <span class="built_in">free</span>(page);</span><br><span class="line">+      pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="built_in">free</span>(pager);</span><br><span class="line">+  <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">-<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">+<span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table* table)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">+    <span class="built_in">db_close</span>(table);</span><br><span class="line">     <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br></pre></td></tr></table></figure>

<p>åœ¨æˆ‘ä»¬ç›®å‰çš„è®¾è®¡ä¸­ï¼Œæ–‡ä»¶çš„é•¿åº¦å–å†³äºæ•°æ®åº“ä¸­çš„è¡Œæ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é¢å¤–åœ¨æœ«å°¾å†™å…¥ä¸€é¡µ(å¦‚æœè¡Œæ•°ä¸æ˜¯<code>rows_per_page</code>çš„æ•´æ•°å€).è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>pager_flush()</code>å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•° - pageä¸‹æ ‡å’Œå¤§å°.è¿™ä¸æ˜¯æœ€å¥½çš„è®¾è®¡ï¼Œä¸è¿‡å½“æˆ‘ä»¬å®ç°B-treeçš„æ—¶å€™å°±ä¸éœ€è¦è¿™ä¸ªäº†.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="function"><span class="type">void</span> <span class="title">pager_flush</span><span class="params">(Pager* pager, <span class="type">uint32_t</span> page_num, <span class="type">uint32_t</span> size)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Tried to flush null page\n&quot;</span>);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">off_t</span> offset = <span class="built_in">lseek</span>(pager-&gt;file_descriptor, page_num * PAGE_SIZE, SEEK_SET);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (offset == <span class="number">-1</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Error seeking: %d\n&quot;</span>, errno);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">ssize_t</span> bytes_written =</span><br><span class="line">+      <span class="built_in">write</span>(pager-&gt;file_descriptor, pager-&gt;pages[page_num], size);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (bytes_written == <span class="number">-1</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Error writing: %d\n&quot;</span>, errno);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦æ¥å—å‘½ä»¤è¡Œå‚æ•°ä¼ é€’çš„æ–‡ä»¶å.ä¸è¦å¿˜äº†è¿˜è¦ç»™<code>do_meta_command</code>å‡½æ•°åŠ ä¸€ä¸ªé¢å¤–çš„å‚æ•°.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">-  Table* table = <span class="built_in">new_table</span>();</span><br><span class="line">+  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">+    <span class="built_in">printf</span>(<span class="string">&quot;Must supply a database filename.\n&quot;</span>);</span><br><span class="line">+    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">char</span>* filename = argv[<span class="number">1</span>];</span><br><span class="line">+  Table* table = <span class="built_in">db_open</span>(filename);</span><br><span class="line">+</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line">     <span class="built_in">read_input</span>(input_buffer);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (input_buffer-&gt;buffer[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">-      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer)) &#123;</span><br><span class="line">+      <span class="keyword">switch</span> (<span class="built_in">do_meta_command</span>(input_buffer, table)) &#123;</span><br></pre></td></tr></table></figure>

<p>åšå®Œè¿™äº›ä¿®æ”¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…³é—­å’Œé‡æ–°æ‰“å¼€æ•°æ®åº“è¾£ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„è®°å½•è¿˜åœ¨.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ ./db mydb.db</span><br><span class="line">db &gt; insert 1 cstack foo@bar.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; insert 2 voltorb volty@example.com</span><br><span class="line">Executed.</span><br><span class="line">db &gt; .exit</span><br><span class="line">~</span><br><span class="line">~ ./db mydb.db</span><br><span class="line">db &gt; select</span><br><span class="line">(1, cstack, foo@bar.com)</span><br><span class="line">(2, voltorb, volty@example.com)</span><br><span class="line">Executed.</span><br><span class="line">db &gt; .exit</span><br><span class="line">~</span><br></pre></td></tr></table></figure>

<p>For extra fun,è®©æˆ‘ä»¬æ‰“å¼€mydb.dbçœ‹çœ‹æ•°æ®æ˜¯å¦‚ä½•è¢«å­˜å‚¨çš„.æˆ‘å°†ä¼šä½¿ç”¨vimä»¥16è¿›åˆ¶æ¨¡å¼æŸ¥çœ‹æ–‡ä»¶çš„å†…å­˜å¸ƒå±€:</p>
<p>æ–‡ä»¶æ ¼å¼</p>
<p><img src="https://cstack.github.io/db_tutorial/assets/images/file-format.png" alt="img: Current File Format"></img></p>
<p>å¼€å¤´4ä¸ªå­—èŠ‚æ˜¯ç¬¬ä¸€è¡Œçš„id(4ä¸ªå­—èŠ‚å› ä¸ºidæ˜¯<code>uint32_t</code>),å®ƒæ˜¯ä»¥<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E5%AD%97%E8%8A%82%E5%BA%8F">å°ç«¯æ ¼å¼</a>å­˜å‚¨çš„,æ‰€ä»¥æœ€ä½ä½å­—èŠ‚ä¸º<code>0x01</code>,å…¶ä»–3ä¸ºéƒ½ä¸º0x00.æˆ‘ä»¬ä½¿ç”¨<code>memcpy</code>å°†Rowç»“æ„ä½“ä¸­çš„æ•°æ®æ‹·è´åˆ°pageç¼“å­˜,æ‰€ä»¥è¿™ä¹Ÿæ„å‘³ç€å†…å­˜ä¸­çš„ç»“æ„ä½“å˜é‡ä¹Ÿæ˜¯ä»¥å°ç«¯åºå­˜å‚¨çš„.å¤§ç«¯åºè¿˜æ˜¯å°ç«¯åºæ˜¯ç”±æœºå™¨å†³å®šçš„(ä¾‹å¦‚intelå°±æ˜¯å°ç«¯),å¦‚æœæˆ‘ä»¬åœ¨è‡ªå·±çš„æœºå™¨ä¸Šå†™å…¥æ•°æ®åº“æ–‡ä»¶ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªå¤§ç«¯åºçš„æœºå™¨ä¸Šè¯»å–ï¼Œå°±éœ€è¦å®Œå–„<code>serialize_row()</code>å’Œ<code>deserialize_row()</code>å‡½æ•°ï¼Œä¸€ç›´ç”¨åŒä¸€ç§é¡ºåºå­˜å‚¨å’Œå†™å…¥å­—èŠ‚.</p>
<p>åé¢çš„33å­—èŠ‚å­˜å‚¨<code>username</code>å­—ç¬¦ä¸²ï¼Œä»¥<code>nullå­—ç¬¦</code>ä¸ºç»“å°¾.æ˜¾ç„¶â€cstackâ€çš„ASCIIç çš„16è¿›åˆ¶æ ¼å¼ä¸º <code>63 73 74 61 63 6b</code>,ç´§æ¥ç€æ˜¯ä¸€ä¸ªnullå­—ç¬¦(0x00).å‰©ä½™çš„33å­—èŠ‚æœªè¢«ä½¿ç”¨.</p>
<p>usernameåé¢çš„256å­—èŠ‚ç”¨åŒæ ·çš„æ–¹å¼å­˜å‚¨<code>email</code>ï¼Œåœ¨nullå­—ç¬¦ä¹‹åå¯ä»¥çœ‹åˆ°ä¸€äº›éšæœºçš„junkï¼Œè¿™ç©æ„çš„æ¥æºå¾ˆå¯èƒ½æ˜¯Rowç»“æ„ä½“æœªåˆå§‹åŒ–çš„å†…å­˜.æˆ‘ä»¬å°†æ•´æ•´256å­—èŠ‚çš„emailç¼“å­˜æ‹·è´å…¥æ–‡ä»¶,å½“æŠŠå†…å­˜åˆ†é…ç»™ç»“æ„ä½“æ—¶ï¼Œå†…å­˜ä¸­çš„å†…å®¹è¿˜åœ¨é‚£å„¿.ä½†æ˜¯å› ä¸ºæˆ‘ä»¬ç”¨äº†nullå­—ç¬¦æ ‡è¯†å­—ç¬¦ä¸²æœ«å°¾ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“.</p>
<p><strong>æ³¨æ„</strong>: å¦‚æœæˆ‘ä»¬æƒ³è¦ç¡®ä¿æ‰€æœ‰å­—èŠ‚éƒ½ä¼šè¢«åˆå§‹åŒ–ï¼Œä½¿ç”¨<code>strncpy</code>å°†usernameå’Œemailæ‹·è´è¿›å†…å­˜(è€Œä¸æ˜¯<code>memcpy</code>)å°±å¯ä»¥ï¼Œå°±åƒè¿™æ ·:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="type">void</span> <span class="title">serialize_row</span><span class="params">(Row* source, <span class="type">void</span>* destination)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">memcpy</span>(destination + ID_OFFSET, &amp;(source-&gt;id), ID_SIZE);</span><br><span class="line">-    <span class="built_in">memcpy</span>(destination + USERNAME_OFFSET, &amp;(source-&gt;username), USERNAME_SIZE);</span><br><span class="line">-    <span class="built_in">memcpy</span>(destination + EMAIL_OFFSET, &amp;(source-&gt;email), EMAIL_SIZE);</span><br><span class="line">+    <span class="built_in">strncpy</span>(destination + USERNAME_OFFSET, source-&gt;username, USERNAME_SIZE);</span><br><span class="line">+    <span class="built_in">strncpy</span>(destination + EMAIL_OFFSET, source-&gt;email, EMAIL_SIZE);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨: æˆ‘æƒ³ä½ ä»¬åº”è¯¥æ‡’å¾—æŸ¥cpp ref,æˆ‘å¸®ä½ ä»¬æŸ¥å§</p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-25/fa4eebcdd18b319009753543f40ddc66.png" alt="image-20220425213839123"></p>
<p><img src="https://gitee.com/salt3dfish/images/raw/master/hexo/22-04-25/24f372655fb1925fefb8d72ff920b7d0.png" alt="image-20220425213633941"></p>
<p>å¤§è‡´æ„æ€å°±æ˜¯ï¼Œå¦‚æœsrc(åŒ…æ‹¬nullå­—ç¬¦)å…¨éƒ½æ‹·è´è¿›äº†dest,è¿˜æ˜¯æ²¡èƒ½è¾¾åˆ°<code>count</code>ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆdestå‰©ä½™çš„éƒ¨åˆ†éƒ½å¡«å……nullå­—ç¬¦,ç›´åˆ°è¾¾åˆ°count.</p>
</blockquote>
<h3 id="Conclusion-1"><a href="#Conclusion-1" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>å¥½!æˆ‘ä»¬å·²ç»å®Œæˆäº†æŒä¹…ä¿å­˜ï¼Œä½†è¿˜æœ‰äº›åœ°æ–¹å¯ä»¥æ”¹å–„.ä¾‹å¦‚å¦‚æœä¸ç”¨<code>.exit</code>è€Œæ˜¯ç›´æ¥ç»ˆæ­¢ç¨‹åºï¼Œä¿®æ”¹çš„æ•°æ®å°±ä¼šä¸¢å¤±.æ­¤å¤–ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„pageéƒ½å†™å›äº†ç£ç›˜ï¼Œå³ä½¿æ˜¯ä»ç£ç›˜è¯»å–åˆ°å†…å­˜åä¸€ç›´æ²¡æ”¹å˜çš„é‚£äº›page,è¿™äº›é—®é¢˜æˆ‘ä»¬ä¹‹åéƒ½å¯ä»¥è§£å†³.</p>
<p>ä¸‹ä¸€ç« æˆ‘ä»¬ä¼šä»‹ç»cursors,è¿™ä¼šè®©å®ç°B-treeæ›´å®¹æ˜“ä¸€äº›.</p>
<p>Until then!</p>
<h3 id="Complete-Diff"><a href="#Complete-Diff" class="headerlink" title="Complete Diff"></a>Complete Diff</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">struct</span> <span class="title class_">InputBuffer_t</span> &#123;</span><br><span class="line">   <span class="type">char</span>* buffer;</span><br><span class="line">@@ <span class="number">-62</span>,<span class="number">9</span> +<span class="number">65</span>,<span class="number">16</span> @@ <span class="type">const</span> <span class="type">uint32_t</span> PAGE_SIZE = <span class="number">4096</span>;</span><br><span class="line"> <span class="type">const</span> <span class="type">uint32_t</span> ROWS_PER_PAGE = PAGE_SIZE / ROW_SIZE;</span><br><span class="line"> <span class="type">const</span> <span class="type">uint32_t</span> TABLE_MAX_ROWS = ROWS_PER_PAGE * TABLE_MAX_PAGES;</span><br><span class="line"></span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">+  <span class="type">int</span> file_descriptor;</span><br><span class="line">+  <span class="type">uint32_t</span> file_length;</span><br><span class="line">+  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+&#125; Pager;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">   <span class="type">uint32_t</span> num_rows;</span><br><span class="line">-  <span class="type">void</span>* pages[TABLE_MAX_PAGES];</span><br><span class="line">+  Pager* pager;</span><br><span class="line"> &#125; Table;</span><br><span class="line"></span><br><span class="line">@@ <span class="number">-84</span>,<span class="number">32</span> +<span class="number">94</span>,<span class="number">81</span> @@ <span class="function"><span class="type">void</span> <span class="title">deserialize_row</span><span class="params">(<span class="type">void</span> *source, Row* destination)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">memcpy</span>(&amp;(destination-&gt;email), source + EMAIL_OFFSET, EMAIL_SIZE);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">+<span class="function"><span class="type">void</span>* <span class="title">get_page</span><span class="params">(Pager* pager, <span class="type">uint32_t</span> page_num)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (page_num &gt; TABLE_MAX_PAGES) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Tried to fetch page number out of bounds. %d &gt; %d\n&quot;</span>, page_num,</span><br><span class="line">+     	TABLE_MAX_PAGES);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+     <span class="comment">// Cache miss. Allocate memory and load from file.</span></span><br><span class="line">+     <span class="type">void</span>* page = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">+     <span class="type">uint32_t</span> num_pages = pager-&gt;file_length / PAGE_SIZE;</span><br><span class="line">+</span><br><span class="line">+     <span class="comment">// We might save a partial page at the end of the file</span></span><br><span class="line">+     <span class="keyword">if</span> (pager-&gt;file_length % PAGE_SIZE) &#123;</span><br><span class="line">+         num_pages += <span class="number">1</span>;</span><br><span class="line">+     &#125;</span><br><span class="line">+</span><br><span class="line">+     <span class="keyword">if</span> (page_num &lt;= num_pages) &#123;</span><br><span class="line">+         <span class="built_in">lseek</span>(pager-&gt;file_descriptor, page_num * PAGE_SIZE, SEEK_SET);</span><br><span class="line">+         <span class="type">ssize_t</span> bytes_read = <span class="built_in">read</span>(pager-&gt;file_descriptor, page, PAGE_SIZE);</span><br><span class="line">+         <span class="keyword">if</span> (bytes_read == <span class="number">-1</span>) &#123;</span><br><span class="line">+     	<span class="built_in">printf</span>(<span class="string">&quot;Error reading file: %d\n&quot;</span>, errno);</span><br><span class="line">+     	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+         &#125;</span><br><span class="line">+     &#125;</span><br><span class="line">+</span><br><span class="line">+     pager-&gt;pages[page_num] = page;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> pager-&gt;pages[page_num];</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function"><span class="type">void</span>* <span class="title">row_slot</span><span class="params">(Table* table, <span class="type">uint32_t</span> row_num)</span> </span>&#123;</span><br><span class="line">   <span class="type">uint32_t</span> page_num = row_num / ROWS_PER_PAGE;</span><br><span class="line">-  <span class="type">void</span> *page = table-&gt;pages[page_num];</span><br><span class="line">-  <span class="keyword">if</span> (page == <span class="literal">NULL</span>) &#123;</span><br><span class="line">-     <span class="comment">// Allocate memory only when we try to access page</span></span><br><span class="line">-     page = table-&gt;pages[page_num] = <span class="built_in">malloc</span>(PAGE_SIZE);</span><br><span class="line">-  &#125;</span><br><span class="line">+  <span class="type">void</span> *page = <span class="built_in">get_page</span>(table-&gt;pager, page_num);</span><br><span class="line">   <span class="type">uint32_t</span> row_offset = row_num % ROWS_PER_PAGE;</span><br><span class="line">   <span class="type">uint32_t</span> byte_offset = row_offset * ROW_SIZE;</span><br><span class="line">   <span class="keyword">return</span> page + byte_offset;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">-<span class="function">Table* <span class="title">new_table</span><span class="params">()</span> </span>&#123;</span><br><span class="line">-  Table* table = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Table));</span><br><span class="line">-  table-&gt;num_rows = <span class="number">0</span>;</span><br><span class="line">+<span class="function">Pager* <span class="title">pager_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename)</span> </span>&#123;</span><br><span class="line">+  <span class="type">int</span> fd = <span class="built_in">open</span>(filename,</span><br><span class="line">+     	  O_RDWR | 	<span class="comment">// Read/Write mode</span></span><br><span class="line">+     	      O_CREAT,	<span class="comment">// Create file if it does not exist</span></span><br><span class="line">+     	  S_IWUSR |	<span class="comment">// User write permission</span></span><br><span class="line">+     	      S_IRUSR	<span class="comment">// User read permission</span></span><br><span class="line">+     	  );</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Unable to open file\n&quot;</span>);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">off_t</span> file_length = <span class="built_in">lseek</span>(fd, <span class="number">0</span>, SEEK_END);</span><br><span class="line">+</span><br><span class="line">+  Pager* pager = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Pager));</span><br><span class="line">+  pager-&gt;file_descriptor = fd;</span><br><span class="line">+  pager-&gt;file_length = file_length;</span><br><span class="line">+</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">-     table-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+     pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">-  <span class="keyword">return</span> table;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> pager;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">-<span class="function"><span class="type">void</span> <span class="title">free_table</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">-  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; table-&gt;pages[i]; i++) &#123;</span><br><span class="line">-     <span class="built_in">free</span>(table-&gt;pages[i]);</span><br><span class="line">-  &#125;</span><br><span class="line">-  <span class="built_in">free</span>(table);</span><br><span class="line">+<span class="function">Table* <span class="title">db_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename)</span> </span>&#123;</span><br><span class="line">+  Pager* pager = <span class="built_in">pager_open</span>(filename);</span><br><span class="line">+  <span class="type">uint32_t</span> num_rows = pager-&gt;file_length / ROW_SIZE;</span><br><span class="line">+</span><br><span class="line">+  Table* table = <span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Table));</span><br><span class="line">+  table-&gt;pager = pager;</span><br><span class="line">+  table-&gt;num_rows = num_rows;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> table;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function">InputBuffer* <span class="title">new_input_buffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">@@ <span class="number">-142</span>,<span class="number">10</span> +<span class="number">201</span>,<span class="number">76</span> @@ <span class="function"><span class="type">void</span> <span class="title">close_input_buffer</span><span class="params">(InputBuffer* input_buffer)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">free</span>(input_buffer);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">pager_flush</span><span class="params">(Pager* pager, <span class="type">uint32_t</span> page_num, <span class="type">uint32_t</span> size)</span> </span>&#123;</span><br><span class="line">+  <span class="keyword">if</span> (pager-&gt;pages[page_num] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Tried to flush null page\n&quot;</span>);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">off_t</span> offset = <span class="built_in">lseek</span>(pager-&gt;file_descriptor, page_num * PAGE_SIZE,</span><br><span class="line">+     		 SEEK_SET);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (offset == <span class="number">-1</span>) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Error seeking: %d\n&quot;</span>, errno);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">ssize_t</span> bytes_written = <span class="built_in">write</span>(</span><br><span class="line">+     pager-&gt;file_descriptor, pager-&gt;pages[page_num], size</span><br><span class="line">+     );</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">if</span> (bytes_written == <span class="number">-1</span>) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Error writing: %d\n&quot;</span>, errno);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="type">void</span> <span class="title">db_close</span><span class="params">(Table* table)</span> </span>&#123;</span><br><span class="line">+  Pager* pager = table-&gt;pager;</span><br><span class="line">+  <span class="type">uint32_t</span> num_full_pages = table-&gt;num_rows / ROWS_PER_PAGE;</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; num_full_pages; i++) &#123;</span><br><span class="line">+     <span class="keyword">if</span> (pager-&gt;pages[i] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">+         <span class="keyword">continue</span>;</span><br><span class="line">+     &#125;</span><br><span class="line">+     <span class="built_in">pager_flush</span>(pager, i, PAGE_SIZE);</span><br><span class="line">+     <span class="built_in">free</span>(pager-&gt;pages[i]);</span><br><span class="line">+     pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="comment">// There may be a partial page to write to the end of the file</span></span><br><span class="line">+  <span class="comment">// This should not be needed after we switch to a B-tree</span></span><br><span class="line">+  <span class="type">uint32_t</span> num_additional_rows = table-&gt;num_rows % ROWS_PER_PAGE;</span><br><span class="line">+  <span class="keyword">if</span> (num_additional_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">+     <span class="type">uint32_t</span> page_num = num_full_pages;</span><br><span class="line">+     <span class="keyword">if</span> (pager-&gt;pages[page_num] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">+         <span class="built_in">pager_flush</span>(pager, page_num, num_additional_rows * ROW_SIZE);</span><br><span class="line">+         <span class="built_in">free</span>(pager-&gt;pages[page_num]);</span><br><span class="line">+         pager-&gt;pages[page_num] = <span class="literal">NULL</span>;</span><br><span class="line">+     &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">int</span> result = <span class="built_in">close</span>(pager-&gt;file_descriptor);</span><br><span class="line">+  <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">+     <span class="built_in">printf</span>(<span class="string">&quot;Error closing db file.\n&quot;</span>);</span><br><span class="line">+     <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; TABLE_MAX_PAGES; i++) &#123;</span><br><span class="line">+     <span class="type">void</span>* page = pager-&gt;pages[i];</span><br><span class="line">+     <span class="keyword">if</span> (page) &#123;</span><br><span class="line">+         <span class="built_in">free</span>(page);</span><br><span class="line">+         pager-&gt;pages[i] = <span class="literal">NULL</span>;</span><br><span class="line">+     &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="built_in">free</span>(pager);</span><br><span class="line">+  <span class="built_in">free</span>(table);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">MetaCommandResult <span class="title">do_meta_command</span><span class="params">(InputBuffer* input_buffer, Table *table)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strcmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;.exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="built_in">close_input_buffer</span>(input_buffer);</span><br><span class="line">-    <span class="built_in">free_table</span>(table);</span><br><span class="line">+    <span class="built_in">db_close</span>(table);</span><br><span class="line">     <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> META_COMMAND_UNRECOGNIZED_COMMAND;</span><br><span class="line">@@ <span class="number">-182</span>,<span class="number">6</span> +<span class="number">308</span>,<span class="number">7</span> @@ <span class="function">PrepareResult <span class="title">prepare_insert</span><span class="params">(InputBuffer* input_buffer, Statement* statement)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> PREPARE_SUCCESS;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line"> <span class="function">PrepareResult <span class="title">prepare_statement</span><span class="params">(InputBuffer* input_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 Statement* statement)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">strncmp</span>(input_buffer-&gt;buffer, <span class="string">&quot;insert&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">@@ <span class="number">-227</span>,<span class="number">7</span> +<span class="number">354</span>,<span class="number">14</span> @@ <span class="function">ExecuteResult <span class="title">execute_statement</span><span class="params">(Statement* statement, Table *table)</span> </span>&#123;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">-  Table* table = <span class="built_in">new_table</span>();</span><br><span class="line">+  <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">+      <span class="built_in">printf</span>(<span class="string">&quot;Must supply a database filename.\n&quot;</span>);</span><br><span class="line">+      <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">char</span>* filename = argv[<span class="number">1</span>];</span><br><span class="line">+  Table* table = <span class="built_in">db_open</span>(filename);</span><br><span class="line">+</span><br><span class="line">   InputBuffer* input_buffer = <span class="built_in">new_input_buffer</span>();</span><br><span class="line">   <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">     <span class="built_in">print_prompt</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™æ˜¯æµ‹è¯•éƒ¨åˆ†çš„æ”¹åŠ¨:</p>
<blockquote>
<p>å‘ƒ..åŸä½œè€…æœ‰ç‚¹ä¸å¤ªç»†å¿ƒ</p>
<p>å®é™…ä¸Šè‡ªä»part4æŠŠemailå’Œusernameçš„å¤§å°éƒ½åŠ äº†1å­—èŠ‚åï¼Œæœ€å¤§å­˜å‚¨çš„è¡Œæ•°ä¸º1300</p>
<p>4096&#x2F;(4+33+256&#x3D;293)&#x3D;13.9 ä¹Ÿå°±æ˜¯æ¯é¡µåªèƒ½å­˜å‚¨13è¡Œ,æœ€å¤š100é¡µ</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">And the diff to our tests:</span><br><span class="line"></span><br><span class="line"> describe <span class="symbol">&#x27;database</span>&#x27; <span class="keyword">do</span></span><br><span class="line">+  before <span class="keyword">do</span></span><br><span class="line">+    `rm -rf test.db`</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">   def <span class="title function_ invoke__">run_script</span>(commands)</span><br><span class="line">     raw_output = nil</span><br><span class="line">-    IO.<span class="title function_ invoke__">popen</span>(<span class="string">&quot;./db&quot;</span>, <span class="string">&quot;r+&quot;</span>) <span class="keyword">do</span> |pipe|</span><br><span class="line">+    IO.<span class="title function_ invoke__">popen</span>(<span class="string">&quot;./db test.db&quot;</span>, <span class="string">&quot;r+&quot;</span>) <span class="keyword">do</span> |pipe|</span><br><span class="line">       commands.each <span class="keyword">do</span> |command|</span><br><span class="line">         pipe.puts command</span><br><span class="line">       end</span><br><span class="line">@@ -<span class="number">28</span>,<span class="number">6</span> +<span class="number">32</span>,<span class="number">27</span> @@ describe <span class="symbol">&#x27;database</span>&#x27; <span class="keyword">do</span></span><br><span class="line">     ])</span><br><span class="line">   end</span><br><span class="line"></span><br><span class="line">+  it <span class="symbol">&#x27;keeps</span> data after closing connection&#x27; <span class="keyword">do</span></span><br><span class="line">+    result1 = <span class="title function_ invoke__">run_script</span>([</span><br><span class="line">+      <span class="string">&quot;insert 1 user1 person1@example.com&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result1).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+</span><br><span class="line">+    result2 = <span class="title function_ invoke__">run_script</span>([</span><br><span class="line">+      <span class="string">&quot;select&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;.exit&quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+    <span class="title function_ invoke__">expect</span>(result2).to <span class="title function_ invoke__">match_array</span>([</span><br><span class="line">+      <span class="string">&quot;db &gt; (1, user1, person1@example.com)&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;Executed.&quot;</span>,</span><br><span class="line">+      <span class="string">&quot;db &gt; &quot;</span>,</span><br><span class="line">+    ])</span><br><span class="line">+  end</span><br><span class="line">+</span><br><span class="line">   it <span class="symbol">&#x27;prints</span> error message when table is full&#x27; <span class="keyword">do</span></span><br><span class="line">     script = (<span class="number">1</span>..<span class="number">1401</span>).map <span class="keyword">do</span> |i|</span><br><span class="line">       <span class="string">&quot;insert #&#123;i&#125; user#&#123;i&#125; person#&#123;i&#125;@example.com&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Part-6-The-Cursor-Abstraction"><a href="#Part-6-The-Cursor-Abstraction" class="headerlink" title="Part 6 - The Cursor Abstraction"></a>Part 6 - The Cursor Abstraction</h2>
    </div>
  </div>
</article> 
  </div>
  
<link rel="stylesheet" href="/css/footer.css">


<div id="footer"></div>
 
</body>